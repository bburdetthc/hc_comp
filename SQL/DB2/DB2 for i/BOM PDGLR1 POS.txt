SELECT * FROM
(
SELECT
	G.PART, KBPO#, KBQTYR, KBQTYO, KBUPRC, KBPUNT, ROW_NUMBER() OVER (PARTITION BY PART) RN
FROM
	(
		SELECT DISTINCT
			G.PART
		FROM 
			(
			SELECT 
				PART, BTID, WRKO,
				ROW_NUMBER() OVER (PARTITION BY PART ORDER BY PART ASC, BTID DESC) RN
			FROM
				RLARP.FFPDGLR1
			WHERE
				SUBSTR(PART,1,8) IN ('PBP11000','PBH12000') AND
				ACTN = 'CPG'
			ORDER BY PART ASC, BTID desc
			) X 
			INNER JOIN RLARP.FFPDGLR1 G ON
				G.BTID = X.BTID AND
				G.WRKO = X.WRKO
		WHERE
			X.RN <= 30 AND
			ACTN IN ('CPG','CPS','SBG','SBS','BMT')
	) X
	INNER JOIN LGDAT.POI ON	
		KBPT# = X.PART
) P
WHERE	
	RN <= 10