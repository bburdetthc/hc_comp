WITH CUR AS (
SELECT
    MAST,
    MPLT,
	SUM(
			CASE MAJG||RQBY||REPL
				WHEN '710R2' THEN 
					ERQTY + ERQTYS
				ELSE 0
			END
	) RES_REQ_QTY,
	SUM(
			CASE MAJG||RQBY||REPL
				WHEN '710B2' THEN 
					ERQTY + ERQTYS
				ELSE 0
			END
	) RES_BYP_QTY,
		SUM(
			CASE MAJG||RQBY||REPL
				WHEN '710R2' THEN 
					BASEX + BASEXS
				ELSE 0
			END
	) RES_REQ_VAL,
	SUM(
			CASE MAJG||RQBY||REPL
				WHEN '710B2' THEN 
					BASEX + BASEXS
				ELSE 0
			END
	) RES_BYP_VAL,
	SUM(
		CASE MAJG
			WHEN '910' THEN
				CASE MING
					WHEN 'D10 - CORRUGATE' THEN BASEX + BASEXS
					ELSE 0
				END
			ELSE 0
		END
	) D10_CORRUGATE,
	SUM(
		CASE MAJG
			WHEN '910' THEN
				CASE MING
					WHEN 'D11 - PALLET' THEN BASEX + BASEXS
					ELSE 0
				END
			ELSE 0
		END
	) D11_PALLET,
	SUM(
		CASE MAJG
			WHEN '910' THEN
				CASE MING
					WHEN 'D12 - LABEL' THEN BASEX + BASEXS
					ELSE 0
				END
			ELSE 0
		END
	) D12_LABEL,
	SUM(
		CASE MAJG
			WHEN '910' THEN
				CASE MING
					WHEN 'D13 - WRAP' THEN BASEX + BASEXS
					ELSE 0
				END
			ELSE 0
		END
	) D13_WRAP,
    SUM(COALESCE(BASEX,0)) BASE,
    SUM(COALESCE(FRTX,0)) FREIGHT,
    SUM(COALESCE(DUTYX,0)) DUTY,
    SUM(COALESCE(MULT1X,0)) MULT1,
    SUM(COALESCE(MULT2X,0)) MULT2,
    SUM(COALESCE(SHIPHX,0)) SHIPH,
    SUM(COALESCE(OSFTX,0)) SUBFRTOUT,
    SUM(COALESCE(OSFFX,0)) SUBFRTIN,
    SUM(COALESCE(CURRX,0)) CURRENCY,
    SUM(COALESCE(SUBCX,0)) SUBCONTR,
    SUM(LABRX) LABRUN,
    SUM(VARRX) VARRUN,
    SUM(FIXRX) FIXRUN,
    SUM(LABSX) LABSET,
    SUM(VARSX) VARSET,
    SUM(FIXSX) FIXSET,
    SUM(
        COALESCE(BASEXS,0) +
        COALESCE(FRTXS,0) +
        COALESCE(DUTYXS,0) +
        COALESCE(MULT1XS,0) +
        COALESCE(MULT2XS,0) +
        COALESCE(SHIPHXS,0) +
        COALESCE(OSFTXS,0) +
        COALESCE(OSFFXS,0) +
        COALESCE(CURRXS,0) +
        COALESCE(SUBCXS,0) +
        COALESCE(LABRXS,0)+
        COALESCE(VARRXS,0)+
        COALESCE(FIXRXS,0)+
        COALESCE(LABSXS,0)+
        COALESCE(VARSXS,0)+
        COALESCE(FIXSXS,0)
    ) SCRAP,
    ROUND(
        SUM(
                ---good----
                COALESCE(BASEX,0) +
                COALESCE(FRTX,0) +
                COALESCE(DUTYX,0) +
                COALESCE(MULT1X,0) +
                COALESCE(MULT2X,0) +
                COALESCE(SHIPHX,0) +
                COALESCE(OSFTX,0) +
                COALESCE(OSFFX,0) +
                COALESCE(CURRX,0) +
                COALESCE(SUBCX,0) +
                COALESCE(LABRX,0)+
                COALESCE(VARRX,0)+
                COALESCE(FIXRX,0)+
                COALESCE(LABSX,0)+
                COALESCE(VARSX,0)+
                COALESCE(FIXSX,0)+
                ---scrap----
                COALESCE(BASEXS,0) +
                COALESCE(FRTXS,0) +
                COALESCE(DUTYXS,0) +
                COALESCE(MULT1XS,0) +
                COALESCE(MULT2XS,0) +
                COALESCE(SHIPHXS,0) +
                COALESCE(OSFTXS,0) +
                COALESCE(OSFFXS,0) +
                COALESCE(CURRXS,0) +
                COALESCE(SUBCXS,0) +
                COALESCE(LABRXS,0)+
                COALESCE(VARRXS,0)+
                COALESCE(FIXRXS,0)+
                COALESCE(LABSXS,0)+
                COALESCE(VARSXS,0)+
                COALESCE(FIXSXS,0)
        )
    ,5) TOTAL_CALC
FROM
    QGPL.FFBSREQC
GROUP BY
    MAST,
    MPLT
),
FUT AS (
SELECT
    MAST,
    MPLT,
	SUM(
			CASE MAJG||RQBY||REPL
				WHEN '710R2' THEN 
					ERQTY + ERQTYS
				ELSE 0
			END
	) RES_REQ_QTY,
	SUM(
			CASE MAJG||RQBY||REPL
				WHEN '710B2' THEN 
					ERQTY + ERQTYS
				ELSE 0
			END
	) RES_BYP_QTY,
		SUM(
			CASE MAJG||RQBY||REPL
				WHEN '710R2' THEN 
					BASEX + BASEXS
				ELSE 0
			END
	) RES_REQ_VAL,
	SUM(
			CASE MAJG||RQBY||REPL
				WHEN '710B2' THEN 
					BASEX + BASEXS
				ELSE 0
			END
	) RES_BYP_VAL,
	SUM(
		CASE MAJG
			WHEN '910' THEN
				CASE MING
					WHEN 'D10 - CORRUGATE' THEN BASEX + BASEXS
					ELSE 0
				END
			ELSE 0
		END
	) D10_CORRUGATE,
	SUM(
		CASE MAJG
			WHEN '910' THEN
				CASE MING
					WHEN 'D11 - PALLET' THEN BASEX + BASEXS
					ELSE 0
				END
			ELSE 0
		END
	) D11_PALLET,
	SUM(
		CASE MAJG
			WHEN '910' THEN
				CASE MING
					WHEN 'D12 - LABEL' THEN BASEX + BASEXS
					ELSE 0
				END
			ELSE 0
		END
	) D12_LABEL,
	SUM(
		CASE MAJG
			WHEN '910' THEN
				CASE MING
					WHEN 'D13 - WRAP' THEN BASEX + BASEXS
					ELSE 0
				END
			ELSE 0
		END
	) D13_WRAP,
    SUM(COALESCE(BASEX,0)) BASE,
    SUM(COALESCE(FRTX,0)) FREIGHT,
    SUM(COALESCE(DUTYX,0)) DUTY,
    SUM(COALESCE(MULT1X,0)) MULT1,
    SUM(COALESCE(MULT2X,0)) MULT2,
    SUM(COALESCE(SHIPHX,0)) SHIPH,
    SUM(COALESCE(OSFTX,0)) SUBFRTOUT,
    SUM(COALESCE(OSFFX,0)) SUBFRTIN,
    SUM(COALESCE(CURRX,0)) CURRENCY,
    SUM(COALESCE(SUBCX,0)) SUBCONTR,
    SUM(LABRX) LABRUN,
    SUM(VARRX) VARRUN,
    SUM(FIXRX) FIXRUN,
    SUM(LABSX) LABSET,
    SUM(VARSX) VARSET,
    SUM(FIXSX) FIXSET,
    SUM(
        COALESCE(BASEXS,0) +
        COALESCE(FRTXS,0) +
        COALESCE(DUTYXS,0) +
        COALESCE(MULT1XS,0) +
        COALESCE(MULT2XS,0) +
        COALESCE(SHIPHXS,0) +
        COALESCE(OSFTXS,0) +
        COALESCE(OSFFXS,0) +
        COALESCE(CURRXS,0) +
        COALESCE(SUBCXS,0) +
        COALESCE(LABRXS,0)+
        COALESCE(VARRXS,0)+
        COALESCE(FIXRXS,0)+
        COALESCE(LABSXS,0)+
        COALESCE(VARSXS,0)+
        COALESCE(FIXSXS,0)
    ) SCRAP,
    ROUND(
        SUM(
                ---good----
                COALESCE(BASEX,0) +
                COALESCE(FRTX,0) +
                COALESCE(DUTYX,0) +
                COALESCE(MULT1X,0) +
                COALESCE(MULT2X,0) +
                COALESCE(SHIPHX,0) +
                COALESCE(OSFTX,0) +
                COALESCE(OSFFX,0) +
                COALESCE(CURRX,0) +
                COALESCE(SUBCX,0) +
                COALESCE(LABRX,0)+
                COALESCE(VARRX,0)+
                COALESCE(FIXRX,0)+
                COALESCE(LABSX,0)+
                COALESCE(VARSX,0)+
                COALESCE(FIXSX,0)+
                ---scrap----
                COALESCE(BASEXS,0) +
                COALESCE(FRTXS,0) +
                COALESCE(DUTYXS,0) +
                COALESCE(MULT1XS,0) +
                COALESCE(MULT2XS,0) +
                COALESCE(SHIPHXS,0) +
                COALESCE(OSFTXS,0) +
                COALESCE(OSFFXS,0) +
                COALESCE(CURRXS,0) +
                COALESCE(SUBCXS,0) +
                COALESCE(LABRXS,0)+
                COALESCE(VARRXS,0)+
                COALESCE(FIXRXS,0)+
                COALESCE(LABSXS,0)+
                COALESCE(VARSXS,0)+
                COALESCE(FIXSXS,0)
        )
    ,5) TOTAL_CALC
FROM
    QGPL.FFBSREQF
GROUP BY
    MAST,
    MPLT
)

SELECT
	VERSION,
	CHAN,
	GEO,
	ACCOUNT,
	GLEC,
	PLNT,
	PART,
	STATEMENT_LINE,
	R_CURRENCY,
	C_CURRENCY,
	MAJG,
	MING,
	MAJS,
	MINS,
	--COALESCE(R.REPP,SPECIAL_SAUCE_REP) CUSTOM_REP,
	SUBSTR(DIGITS(YEAR(B_ORDERDATE + I_ORDERDATE DAYS)),9)||SUBSTR(DIGITS(MONTH(B_ORDERDATE + I_ORDERDATE DAYS)),9) ORDERDATE,
	SUBSTR(DIGITS(YEAR(B_REQUESTDATE + I_REQUESTDATE DAYS)),9)||SUBSTR(DIGITS(MONTH(B_REQUESTDATE + I_REQUESTDATE DAYS)),9) REQUESTDATE,
	SUBSTR(DIGITS(YEAR(B_SHIPDATE+ I_SHIPDATE DAYS)),9)||SUBSTR(DIGITS(MONTH(B_SHIPDATE + I_SHIPDATE DAYS)),9) SHIPDATE,
	SUM(I_SHIPDATE) I_SHIPDATE,
	SUM(VALUE_LOCAL*CASE R_CURRENCY WHEN 'CA' THEN .75 ELSE 1 END) REVENUE_USD,
	SUM(QTY*COALESCE(CGSTCS, CHSTCS, Y0STCS, NPCOST)*CASE C_CURRENCY WHEN 'CA' THEN .75 ELSE 1 END) SCOGS_CUR_USD,
	SUM(QTY*COALESCE(CNSTCS, COSTCS, Y3STCS, NPCOST)*CASE C_CURRENCY WHEN 'CA' THEN .75 ELSE 1 END) SCOGS_FUT_USD,
	SUM(QTY*COALESCE(CUR.TOTAL_CALC, NPCOST)*CASE C_CURRENCY WHEN 'CA' THEN .75 ELSE 1 END) SCOGS_CCUR_USD,
	SUM(QTY*COALESCE(FUT.TOTAL_CALC, NPCOST)*CASE C_CURRENCY WHEN 'CA' THEN .75 ELSE 1 END) SCOGS_CFUT_USD
FROM
	QGPL.FFBS0403
	LEFT OUTER JOIN CUR ON
		CUR.MAST = PART AND
		CUR.MPLT = PLNT
	LEFT OUTER JOIN FUT ON
		FUT.MAST = PART AND
		FUT.MPLT = PLNT
	LEFT OUTER JOIN LGDAT.ICSTP ON
		CHPART = PART AND
		CHPLNT = PLNT
	LEFT OUTER JOIN LGDAT.ICSTM ON
		CGPART = PART AND
		CGPLNT = PLNT
	LEFT OUTER JOIN LGDAT.ICSTR ON
		Y0PART = PART AND
		Y0PLNT = PLNT
	LEFT OUTER JOIN LGDAT.FTCSTP ON
		COPART = PART AND
		COPLNT = PLNT
	LEFT OUTER JOIN LGDAT.FTCSTM ON
		CNPART = PART AND
		CNPLNT = PLNT
	LEFT OUTER JOIN LGDAT.FTCSTR ON
		Y3PART = PART AND
		Y3PLNT = PLNT
	LEFT OUTER JOIN 
		TABLE ( 
			VALUES
				('SIA20000E21C006LRTJU',3.676),
				('SIA12000E35C012LRTJF',0.879),
				('SIA20000E35C006LRTJR',3.676),
				('SIA12000E21C006LRTJI',0.879),
				('SIA12000A34C012LRTJH',0.879),
				('SIA12000E21C012LAH09',0.879),
				('SIA08000B91C024LRTIY',0.436),
				('SIA12000B91C012LRTJG',0.879),
				('SIA08000E21C024LRTJA',0.436),
				('SIA12000E21C012LRTJI',0.879),
				('SIA08000E35C024LRTIX',0.436),
				('SIA16000E35C012LRTJN',1.848),
				('SIA16000B91C012LRTJO',1.848),
				('SIA16000A34C012LRTJP',1.848),
				('SIA16000E35C012LAH32',1.848),
				('SIA08000A34C024LRTIZ',0.436),
				('SIA16000DC6C012LRBWI',1.848),
				('SIA20000DC6C006LRBWJ',3.676),
				('SIA20000A34C006LRTJT',3.676),
				('SIA16000A34C006LRTJP',1.848),
				('SIA16000E35C006LRTJN',1.848),
				('SIA16000E21C012LRTJQ',1.848),
				('SIA12000E35C006LJN76',0.879),
				('SIA12000BE4C006LJN75',0.879),
				('SIA20000B91C006LRTJS',3.676),
				('SIA20000E21E280',3.676),
				('SIA12000FA9C006LJN77',0.879),
				('SIA16000E22E280',1.848),
				('SIA20000E35E280',3.676),
				('SIA08000A42C024LRBXO',0.436),
				('SIA12000A42C012LRBXQ',0.879),
				('SIA16000A42C012LRBXS',1.848),
				('SIA20000A42C006LRBXT',3.676),
				('SIA16000E21E280',1.848),
				('SIA20000E22C006',3.676),
				('SIA08000DC6C006LJN85',0.436),
				('SIA12000E21E432',0.879),
				('SIA12000DC6C012LRBWG',0.879),
				('SIA12000E35C012LAH10',0.879),
				('SIA12000A42C012LAH46',0.879),
				('SIA16000A42C012LAH45',1.848),
				('SIA08000DC6C024LRBWE',0.436),
				('SIA20000E35C006',3.676),
				('SIA16000E24E280',1.848)
		) NP(NPPART, NPCOST) ON
			NPPART = PART
WHERE
	--SUBSTR(GLEC,1,1) IN ('1','2') AND
	COALESCE(B_SHIPDATE,CAST('2001-01-01' AS DATE)) >= CAST('2017-03-01' AS DATE)
	--NOT (STATUS = 'CLOSED' AND	INVOICE IS NULL)
GROUP BY
	VERSION,
	CHAN,
	GEO,
	ACCOUNT,
	GLEC,
	PLNT,
	PART,
	STATEMENT_LINE,
	R_CURRENCY,
	C_CURRENCY,
	MAJG,
	MING,
	MAJS,
	MINS,
	SUBSTR(DIGITS(YEAR(B_ORDERDATE + I_ORDERDATE DAYS)),9)||SUBSTR(DIGITS(MONTH(B_ORDERDATE + I_ORDERDATE DAYS)),9) ,
	SUBSTR(DIGITS(YEAR(B_REQUESTDATE + I_REQUESTDATE DAYS)),9)||SUBSTR(DIGITS(MONTH(B_REQUESTDATE + I_REQUESTDATE DAYS)),9) ,
	SUBSTR(DIGITS(YEAR(B_SHIPDATE+ I_SHIPDATE DAYS)),9)||SUBSTR(DIGITS(MONTH(B_SHIPDATE + I_SHIPDATE DAYS)),9)
/*
UNION ALL

SELECT
	VERSION,
	CHAN,
	GEO,
	ACCOUNT,
	GLEC,
	PLNT,
	STATEMENT_LINE,
	R_CURRENCY,
	C_CURRENCY,
	MAJG,
	MING,
	MAJS,
	MINS,
	--COALESCE(R.REPP,SPECIAL_SAUCE_REP) CUSTOM_REP,
	SUBSTR(DIGITS(YEAR(B_ORDERDATE + I_ORDERDATE DAYS)),9)||SUBSTR(DIGITS(MONTH(B_ORDERDATE + I_ORDERDATE DAYS)),9) ORDERDATE,
	SUBSTR(DIGITS(YEAR(B_REQUESTDATE + I_REQUESTDATE DAYS)),9)||SUBSTR(DIGITS(MONTH(B_REQUESTDATE + I_REQUESTDATE DAYS)),9) REQUESTDATE,
	SUBSTR(DIGITS(YEAR(B_SHIPDATE+ I_SHIPDATE DAYS)),9)||SUBSTR(DIGITS(MONTH(B_SHIPDATE + I_SHIPDATE DAYS)),9) SHIPDATE,
	SUM(I_SHIPDATE) I_SHIPDATE,
	SUM(VALUE_LOCAL*CASE R_CURRENCY WHEN 'CA' THEN .75 ELSE 1 END) REVENUE_USD,
	SUM(QTY*COALESCE(CGSTCS, CHSTCS, Y0STCS)*CASE C_CURRENCY WHEN 'CA' THEN .75 ELSE 1 END) SCOGS_CUR_USD,
	SUM(QTY*COALESCE(CNSTCS, COSTCS, Y3STCS)*CASE C_CURRENCY WHEN 'CA' THEN .75 ELSE 1 END) SCOGS_FUT_USD,
	SUM(QTY*COALESCE(CUR.TOTAL_CALC,NPCOST)*CASE C_CURRENCY WHEN 'CA' THEN .75 ELSE 1 END) SCOGS_CCUR_USD,
	SUM(QTY*COALESCE(FUT.TOTAL_CALC,NPCOST)*CASE C_CURRENCY WHEN 'CA' THEN .75 ELSE 1 END) SCOGS_CFUT_USD
FROM
	QGPL.FFBSHIST
	LEFT OUTER JOIN CUR ON
		CUR.MAST = PART AND
		CUR.MPLT = PLNT
	LEFT OUTER JOIN FUT ON
		FUT.MAST = PART AND
		FUT.MPLT = PLNT
	LEFT OUTER JOIN LGDAT.ICSTP ON
		CHPART = PART AND
		CHPLNT = PLNT
	LEFT OUTER JOIN LGDAT.ICSTM ON
		CGPART = PART AND
		CGPLNT = PLNT
	LEFT OUTER JOIN LGDAT.ICSTR ON
		Y0PART = PART AND
		Y0PLNT = PLNT
	LEFT OUTER JOIN LGDAT.FTCSTP ON
		COPART = PART AND
		COPLNT = PLNT
	LEFT OUTER JOIN LGDAT.FTCSTM ON
		CNPART = PART AND
		CNPLNT = PLNT
	LEFT OUTER JOIN LGDAT.FTCSTR ON
		Y3PART = PART AND
		Y3PLNT = PLNT
	LEFT OUTER JOIN 
		TABLE ( 
			VALUES
				('SIA20000E21C006LRTJU',3.676),
				('SIA12000E35C012LRTJF',0.879),
				('SIA20000E35C006LRTJR',3.676),
				('SIA12000E21C006LRTJI',0.879),
				('SIA12000A34C012LRTJH',0.879),
				('SIA12000E21C012LAH09',0.879),
				('SIA08000B91C024LRTIY',0.436),
				('SIA12000B91C012LRTJG',0.879),
				('SIA08000E21C024LRTJA',0.436),
				('SIA12000E21C012LRTJI',0.879),
				('SIA08000E35C024LRTIX',0.436),
				('SIA16000E35C012LRTJN',1.848),
				('SIA16000B91C012LRTJO',1.848),
				('SIA16000A34C012LRTJP',1.848),
				('SIA16000E35C012LAH32',1.848),
				('SIA08000A34C024LRTIZ',0.436),
				('SIA16000DC6C012LRBWI',1.848),
				('SIA20000DC6C006LRBWJ',3.676),
				('SIA20000A34C006LRTJT',3.676),
				('SIA16000A34C006LRTJP',1.848),
				('SIA16000E35C006LRTJN',1.848),
				('SIA16000E21C012LRTJQ',1.848),
				('SIA12000E35C006LJN76',0.879),
				('SIA12000BE4C006LJN75',0.879),
				('SIA20000B91C006LRTJS',3.676),
				('SIA20000E21E280',3.676),
				('SIA12000FA9C006LJN77',0.879),
				('SIA16000E22E280',1.848),
				('SIA20000E35E280',3.676),
				('SIA08000A42C024LRBXO',0.436),
				('SIA12000A42C012LRBXQ',0.879),
				('SIA16000A42C012LRBXS',1.848),
				('SIA20000A42C006LRBXT',3.676),
				('SIA16000E21E280',1.848),
				('SIA20000E22C006',3.676),
				('SIA08000DC6C006LJN85',0.436),
				('SIA12000E21E432',0.879),
				('SIA12000DC6C012LRBWG',0.879),
				('SIA12000E35C012LAH10',0.879),
				('SIA12000A42C012LAH46',0.879),
				('SIA16000A42C012LAH45',1.848),
				('SIA08000DC6C024LRBWE',0.436),
				('SIA20000E35C006',3.676),
				('SIA16000E24E280',1.848)
		) NP(NPPART, NPCOST) ON
			NPPART = PART
WHERE
	SUBSTR(GLEC,1,1) IN ('1','2') --AND
	--COALESCE(B_SHIPDATE,CAST('2001-01-01' AS DATE)) >= CAST('2017-03-01' AS DATE)
	--NOT (STATUS = 'CLOSED' AND	INVOICE IS NULL)
GROUP BY
	VERSION,
	CHAN,
	GEO,
	ACCOUNT,
	GLEC,
	PLNT,
	STATEMENT_LINE,
	R_CURRENCY,
	C_CURRENCY,
	MAJG,
	MING,
	MAJS,
	MINS,
	SUBSTR(DIGITS(YEAR(B_ORDERDATE + I_ORDERDATE DAYS)),9)||SUBSTR(DIGITS(MONTH(B_ORDERDATE + I_ORDERDATE DAYS)),9) ,
	SUBSTR(DIGITS(YEAR(B_REQUESTDATE + I_REQUESTDATE DAYS)),9)||SUBSTR(DIGITS(MONTH(B_REQUESTDATE + I_REQUESTDATE DAYS)),9) ,
	SUBSTR(DIGITS(YEAR(B_SHIPDATE+ I_SHIPDATE DAYS)),9)||SUBSTR(DIGITS(MONTH(B_SHIPDATE + I_SHIPDATE DAYS)),9)
*/