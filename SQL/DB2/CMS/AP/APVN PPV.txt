GRANT ALL ON QGPL.VW_FFVPPVD TO PUBLIC


/*
CREATE VIEW QGPL.VW_FFVPPVD
AS
--APVN PPV details
SELECT
	PMT.PERD, PMT.COMP, CASE IFNULL (LBPO#, 0) WHEN 0 THEN 'Unmatched Voucher' ELSE '3-Way Match' END MODULE, 
	PMT.VEND, V.LBPO#, V.LBPOI#, 
	V.LBRKEY, CHAR(V.LBRDAT) LBRDAT, V.LBPT#, 
	COALESCE(RTRIM(V.LBPT#)||CASE WHEN V.LBPT# = '' THEN '' ELSE ' - ' END||RTRIM(V.LBDESC),IDVDES) DESCR, 
	COALESCE(GROUP,RTRIM(BQ1TITL)) GROUP, 
	V.LBBQTY, 
	PMT.INV#, PMT.VCHR, 0 TAXES, 1 EXCHANGE, 
	COALESCE(PMT.LBEXT,IDGROS) TOTAL, 	
	CASE 
		--if the POMVAR (PMT) has nothing, then just use the ledger amount
		WHEN PMT.LBEXT IS NULL THEN PMT.AMT 
		ELSE 
			CASE 
				--if POMVAR explains ppv for the whole voucher within 5 cents, just use POMVAR
				WHEN ABS(PMT.LBEXT-PMT.LBPPV) <= .05 THEN V.LBPPV 
				--if POMVAR does not explain the ledger amount then prorata apply the ledger amount
				--first to the existing line item POMVAR ppv to the whole of the POMVAR voucher ppv
				--but if POMVAR has -0- for the PPV then proportionately apply the ledger amount
				--according to the line item purchase value to the voucher total purchase value
				ELSE 
					CASE 
						WHEN PMT.LBPPV = 0 THEN V.LBEXT/PMT.LBEXT
						ELSE V.LBPPV/PMT.LBPPV
					END*PMT.AMT
			END
	END TRN_AMT,					
	ACCT, AZGROP||' - '||RTRIM(BQ1TITL) FGRP
FROM
(
SELECT
	PERD, COMP, ACCT, VCHR, INV#, CUSVEND||' - '||RTRIM(BTNAME) VEND, AMT, SUM(LBEXT) LBEXT, SUM(LBPPV) LBPPV
FROM
	(
		SELECT 
			T.PERD, SUBSTR(ACCT,1,2) COMP, ACCT, RTRIM(CUSKEY1) VCHR, CUSKEY2 BANK, CUSKEY4 INV#, CUSVEND,
			SUM(AMT*COALESCE(IS,1)) AMT
		FROM 
			QGPL.FFSBGLR1 T
			INNER JOIN LGDAT.MAST ON
				AZCOMP||DIGITS(AZGL#1)||DIGITS(AZGL#2) = T.ACCT
			LEFT OUTER JOIN QGPL.FFFX F ON
				F.PERD = T.PERD AND
				AZFUT2 = 'CA'
		WHERE 
			MODULE = 'APVN' AND 
			T.PERD >= '1503' AND 
			SUBSTR(AZGROP,1,5) = '54010'
		GROUP BY 
			T.PERD, substr(acct,1,2), ACCT, RTRIM(CUSKEY1), CUSKEY2, CUSKEY4, CUSVEND
	) X
	LEFT OUTER JOIN LGDAT.POMVAR  ON
		X.COMP = LBCOM# AND
		X.VCHR = LBVCH#
	LEFT OUTER JOIN LGDAT.VEND ON
		BTVEND = CUSVEND
GROUP BY
	PERD, COMP, ACCT, VCHR, INV#, CUSVEND||' - '||RTRIM(BTNAME), AMT
) PMT
LEFT OUTER JOIN LGDAT.POMVAR V ON
	PMT.COMP = V.LBCOM# AND
	PMT.VCHR = V.LBVCH#
LEFT OUTER JOIN LGDAT.MAST ON
	AZCOMP||DIGITS(AZGL#1)||DIGITS(AZGL#2) = ACCT
LEFT OUTER JOIN LGDAT.FGRP ON
	BQ1GRP = AZGROP
LEFT OUTER JOIN QGPL.FFMGRP ON
	PART = LBPT#
LEFT OUTER JOIN LGDAT.VCHR ON
	IDCOM# = PMT.COMP AND
	IDVCH# = PMT.VCHR AND
	IDINV# = PMT.INV#
*/