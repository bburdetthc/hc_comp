
----------------------------------------------------UNVCOUHERED RECEIPTS-------------------------------------------------------------------
--selecte goods receipts (PORCH) for a date range a couple days into the next period going back as far as deemed necessary			--
--the link to the ledger will then determine which period the items extended into the next month fall into and can be excluded		--
--this link to the ledger will not work for expense PO's since they do not post at receipt time							--
--return to vendor items are pulled below with the exception that the fiscal period is listed for each return so no ledger link required	--
-------------------------------------------------------------------------------------------------------------------------------------------

SELECT DISTINCT --a distinct is necessary because the link to the ledger will duplicate, but all that is needed is the fiscal period
	X.*, 
	SUBSTR(BYFSYY,3,2)||DIGITS(BYFSPR) AS INVPER
FROM 
	(
	SELECT 
		'RECPT' AS MODULE,
 		JSRDAT, JSRLG#, DIGITS(JSRLGI) AS JSRLGI, JSPO#, JSLIN#, JSITYP, JSJOB#, JSPT#,
 		COALESCE(AWMING, AVMING)||'-'||MMGP.BRDES AS MING,
 		JSPLNT, JSQTYR, 
 		IFNULL( IHCNV1,1)/IFNULL(IHCNV2,1) AS UOMC,
 		COALESCE(LBSCST, CGSTCS, CHSTCS, Y0STCS)*JSQTYR AS STCS, 
		COALESCE(LBEXT,JSEXTN), --this is the ext PO price stored in PORCH which doesn't always seem to match the PO
 		KBUPRC*JSQTYR*IFNULL( IHCNV1,1)/IFNULL(IHCNV2,1) AS POPRICE, 	--manual calc of PO price
		COALESCE(LBEXT,JSEXTN)-COALESCE(LBSCST,CGSTCS, CHSTCS, Y0STCS)*COALESCE(LBQREC,JSQTYR) AS PPV, --ppv calc based on PORCH ext PO amount
 		YACOMP||DIGITS(KBGL#) POGL, YACOMP||DIGITS(Y1PRVR) PPVGL,
 		COALESCE(AWGLED, AVGLED) AS GLED,
 		KAOVND, KAOVNM, KAPLNT, LBVCH#, LBCOM#, 
 		'20'|| V.LBFSYY||DIGITS(V.LBFSPP)  AS VCHPER 
	FROM
 		LGDAT.PORCH R
 		LEFT OUTER JOIN LGDAT.POI PO ON
  			PO.KBPO# = JSPO# AND
  			PO.KBITM# = JSLIN#
 		LEFT OUTER JOIN LGDAT.POH ON
  			KAPO# = JSPO#
 		LEFT OUTER JOIN LGDAT.POMVAR V ON
  			V.LBRLG# = R.JSRLG# AND
  			V.LBPO# = R.JSPO# AND
  			V.LBPOI# = R.JSLIN#
 		LEFT OUTER JOIN LGDAT.ICSTP P ON
  			P.CHPART = R.JSPT# AND
  			P.CHPLNT = R.JSPLNT
 		LEFT OUTER JOIN LGDAT.ICSTM M ON
  			M.CGPART = R.JSPT# AND
  			M.CGPLNT = R.JSPLNT
   		LEFT OUTER JOIN LGDAT.ICSTR T ON
  			T.Y0PART = R.JSPT# AND
  			T.Y0PLNT = R.JSPLNT
 		LEFT OUTER JOIN LGDAT.STKMP SP ON
  			SP.AWPART = R.JSPT#
 		LEFT OUTER JOIN LGDAT.STKMM SM ON
  			SM.AVPART = R.JSPT#
 		LEFT OUTER JOIN LGDAT.PUNIT PUNIT ON
  			COALESCE(AVUNTI, AWUNTI) = PUNIT.IHUNT2 AND
  			KBPUNT = PUNIT.IHUNT1 AND
  			IHPART = '&&GLOBAL'
 		LEFT OUTER JOIN LGDAT.GLIE GLIE ON
  			Y1PLNT = JSPLNT AND
  			Y1GLEC = COALESCE(AWGLED, AVGLED)
 		LEFT OUTER JOIN LGDAT.MMGP MMGP ON
  			BRMGRP = COALESCE(AWMING, AVMING) AND
  			BRGRP = COALESCE(AWMAJG, AVMAJG)
		LEFT OUTER JOIN LGDAT.PLNT ON
			YAPLNT = JSPLNT
	WHERE
 		R.JSRDAT >= '2014-10-01' AND 
 		R.JSRDAT < '2014-11-01' AND
 		R.JSPLNT = '152' 
		--AND (V.LBFSYY IS NULL OR V.LBFSYY||DIGITS(V.LBFSPP) >= 1411) 
	) X
	LEFT OUTER JOIN LGDAT.STKT ON
		BYPART = JSPT# AND
		BYPLNT = JSPLNT AND
		BYJREF = COALESCE(JSJOB#,'P'||DIGITS(JSPO#))
		SUBSTR(BYDREF,22,9) = DIGITS(JSRLG#)
UNION

--the 'all' from the union is dropped in order to eliminate duplicate entries in BLRV arising from multiple reason codes per item
SELECT 
	'RETRN' AS MODULE,
 	E4SDAT, E4PORL, E4ENTN||'-'||LBRLG# AS ENT_LOG, E4PON, E4POIN, KBITYP, KBJOB#,E4PART, 
 	COALESCE(AWMING, AVMING)||'-'||MMGP.BRDES AS MING, 
 	E4PLNT, E4QTY, 
 	IFNULL(CNV1,1)/IFNULL(CNV2,1) AS UOMC,
 	-E4QTY*COALESCE(CGSTCS, CHSTCS, Y0STCS) AS STCS, 
 	KBUPRC*-E4QTY*IFNULL( CNV1,1)/IFNULL(CNV2,1) AS POPRICE,
 	KBUPRC*-E4QTY*IFNULL(CNV1,1)/IFNULL(CNV2,1)-COALESCE(CGSTCS, CHSTCS, Y0STCS)*-E4QTY AS PPV,
	KBUPRC*-E4QTY*IFNULL(CNV1,1)/IFNULL(CNV2,1)-COALESCE(CGSTCS, CHSTCS, Y0STCS)*-E4QTY,
 	YACOMP||DIGITS(KBGL#), YACOMP||DIGITS(Y1PRVR),COALESCE(AWGLED, AVGLED) AS GLED,KAOVND, KAOVNM, KAPLNT,
 	LBVCH#, LBCOM#, '20'||LBFSYY||DIGITS(LBFSPP) AS LBYYPP, '20'||E4FISP AS E4YYPP
FROM  
 	LGDAT.BLRV BLRV
 	LEFT OUTER JOIN LGDAT.POI PO ON
  		PO.KBPO# = E4PON AND
  		PO.KBITM# = E4POIN
 	LEFT OUTER JOIN LGDAT.POH ON
  		KAPO# = E4PON
 	LEFT OUTER JOIN LGDAT.POMVAR  ON
  		BLRV.E4PON = LBPO# AND 
  		BLRV.E4POIN = LBPOI#
 	LEFT OUTER JOIN LGDAT.ICSTM M ON
  		CGPART = E4PART AND
  		CGPLNT = E4PLNT
 	LEFT OUTER JOIN LGDAT.ICSTP P ON
  		CHPART = E4PART AND
  		CHPLNT = E4PLNT
 	LEFT OUTER JOIN LGDAT.ICSTR T ON
  		Y0PART = E4PART AND
  		Y0PLNT = E4PLNT
 	LEFT OUTER JOIN LGDAT.STKMP SP ON
  		SP.AWPART = E4PART
 	LEFT OUTER JOIN LGDAT.STKMM SM ON
  		SM.AVPART = E4PART
 	LEFT OUTER JOIN
  	(
  	SELECT 
  		IHPART AS PART, IHUNT1 AS UNT1, IHUNT2 AS UNT2, IHCNV1 AS CNV1, IHCNV2 AS CNV2
	FROM 
  		LGDAT.PUNIT PUNIT
  	WHERE 
  		PUNIT.IHPART='&&GLOBAL'
  	UNION ALL
  	SELECT 
  		IHPART AS PART, IHUNT2 AS UNT1, IHUNT1 AS UNT2, IHCNV2 AS CNV1, IHCNV1 AS CNV2
  	FROM 
  		LGDAT.PUNIT PUNIT
  	WHERE 
  		PUNIT.IHPART='&&GLOBAL'
  	) X ON
    		COALESCE(AWUNTI, AVUNTI) = X.UNT1 AND
    		KBPUNT = X.UNT2
 	LEFT OUTER JOIN LGDAT.GLIE GLIE ON
  		Y1PLNT = E4PLNT AND
  		Y1GLEC = COALESCE(AWGLED, AVGLED)
 	LEFT OUTER JOIN LGDAT.MMGP MMGP ON
  		BRMGRP = COALESCE(AWMING, AVMING) AND
  		BRGRP = COALESCE(AWMAJG, AVMAJG)
	LEFT OUTER JOIN LGDAT.PLNT ON
		YAPLNT = E4PLNT
WHERE  
 	E4FISP >= 1410 AND 
 	E4FISP <= 1410 AND 
 	--(LBFSYY||DIGITS(LBFSPP) >= 140 OR LBFSYY IS NULL) AND
 	E4PLNT='152' AND
       (LBSHP# = 'Vendor Return Entry: 000'||E4ENTN OR LBSHP# IS NULL)

