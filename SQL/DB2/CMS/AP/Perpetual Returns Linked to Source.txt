SELECT
	BYPLNT, 
	YACOMP||Y1INVA AS ACCT,
	BYPART, BYACTN, BYQTY, CHAR(BYTDAT) BYTDAT, BYJREF, BYIREF, BYDREF, BYSEQ#, COALESCE(CGSTCS, CHSTCS, Y0STCS) AS COST,
	COALESCE(CGSTCS, CHSTCS, Y0STCS)*BYQTY*CASE BYACTN WHEN 'I' THEN -1 ELSE 1 END AS XCOST,
	CASE SUBSTR(BYDREF,1,3)
		WHEN 'CRD' THEN CRD.DHINV#||' - '||'CREDIT INVOICE'
		WHEN 'RAN' THEN DCORD#||' - '||'CREDIT NOTE'
	END AS LINKED_KEY,
	DIGITS(BYFSYY)||DIGITS(BYFSPR) AS PERP_PERD,
	COALESCE(DIGITS(CRD.DHARYR)||DIGITS(CRD.DHARPR),DIGITS(RAN.DHARYR)||DIGITS(RAN.DHARPR)) AS CINV_PERD
FROM
	LGDAT.STKT
	LEFT OUTER JOIN LGDAT.ICSTM ON
		CGPART = BYPART AND
		CGPLNT = BYPLNT
	LEFT OUTER JOIN LGDAT.ICSTP ON
		CHPART = BYPART AND 
		CHPLNT = BYPLNT
	LEFT OUTER JOIN LGDAT.ICSTR ON
		Y0PART = BYPART AND
		Y0PLNT = BYPLNT
	LEFT OUTER JOIN LGDAT.STKMP MP ON
		MP.AWPART = BYPART
	LEFT OUTER JOIN LGDAT.STKMM MM ON
		MM.AVPART = BYPART
	LEFT OUTER JOIN LGDAT.GLIE A ON
		Y1GLEC = COALESCE(AVGLED, AWGLED) AND
		Y1PLNT = BYPLNT
	LEFT OUTER JOIN LGDAT.PLNT L ON
		YAPLNT = BYPLNT
	LEFT OUTER JOIN LGDAT.OIH CRD ON
		DIGITS(CRD.DHINV#) = SUBSTR(BYDREF,5,9) AND
		SUBSTR(BYDREF,1,3) = 'CRD'
	LEFT OUTER JOIN LGDAT.RANS ON
		INRNDR = BYJREF AND
		SUBSTR(BYDREF,1,3) = 'RAN'
	LEFT OUTER JOIN LGDAT.CCRH ON
		DCORD# = INCRD#
	LEFT OUTER JOIN LGDAT.OIH RAN ON
		DCINV# = RAN.DHINV#
WHERE 
	BYFSYY = 2014 AND 
	BYFSPR = 2 AND 
	BYSRC = 'OE ' AND UPPER(SUBSTRING(BYDREF,1,3)) IN ('RAN','CRD')
FETCH FIRST 10 ROWS ONLY
