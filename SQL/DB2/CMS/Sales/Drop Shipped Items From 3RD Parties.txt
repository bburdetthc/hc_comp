SELECT	
	DHARYR||DIGITS(DHARPR) AS PERD,
	DHINCR,
	DIGLCD,
	COALESCE(AVTYPE, AWTYPE),
	DIPART,
	DHINV#,
	DHBCS#||' - '||BT.BVNAME AS BILLN,
	BT.BVCLAS||' - '||LTRIM(RTRIM(BC.A30)) AS BILLC, 
	DHSCS#||' - '||ST.BVNAME AS SHIPN,
	ST.BVCLAS||' - '||LTRIM(RTRIM(SC.A30)) AS SHIP, 
	SUM(DIEXT), SUM(DIEXTN)
FROM
	LGDAT.OIH
	INNER JOIN LGDAT.OID ON
		DIINV# = DHINV#
	INNER JOIN LGDAT.CUST ST ON
		ST.BVCUST = DHSCS#
	INNER JOIN LGDAT.CUST BT ON
		BT.BVCUST = DHBCS#
	INNER JOIN LGDAT.CODE SC ON
		ST.BVCLAS = LTRIM(RTRIM(SC.A9)) AND		
		SC.A2 = 'KK'
	INNER JOIN LGDAT.CODE BC ON
		BT.BVCLAS = LTRIM(RTRIM(BC.A9)) AND
		BC.A2 = 'KK'
	LEFT OUTER JOIN LGDAT.STKMM ON
		AVPART = DIPART
	LEFT OUTER JOIN LGDAT.STKMP ON 
		AWPART = DIPART
WHERE
	DHINV# IN 
	(
		SELECT	DISTINCT
			DHINV#
		FROM
			LGDAT.OIH
			INNER JOIN LGDAT.OID ON
				DIINV# = DHINV#
			LEFT OUTER JOIN LGDAT.STKMM ON
				AVPART = DIPART
			LEFT OUTER JOIN LGDAT.STKMP ON 
				AWPART = DIPART
			INNER JOIN LGDAT.CUST ON
				BVCUST = DHBCS#
		WHERE
			DHARYR = 13 AND
			DHBCS# <> DHSCS# AND
			substr(dipart,1,7) <> 'UFRTCHG' AND
			COALESCE(AVTYPE, AWTYPE) = 'R' AND
			SUBSTR(DIGLCD,1,2) NOT IN ('12','13','14','52','53','54','55') AND
			SUBSTR(DIPART,1,4)<> 'MSC0' AND
			BT.BVCLAS NOT IN ('INTC','INTR','SALE') AND
			COALESCE(AVGLED,AWGLED)
	)
GROUP BY
	DHARYR||DIGITS(DHARPR),
	DHINCR,
	DIGLCD, 
	COALESCE(AVTYPE, AWTYPE),
	DIPART,
	DHINV#,
	DHBCS#||' - '||BT.BVNAME,
	BT.BVCLAS||' - '||LTRIM(RTRIM(BC.A30)), 
	DHSCS#||' - '||ST.BVNAME,
	ST.BVCLAS||' - '||LTRIM(RTRIM(SC.A30))
FETCH FIRST 10 ROWS ONLY