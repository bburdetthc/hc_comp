INSERT INTO QGPL.FFSHD
SELECT
	DIGITS(DHARYR)||DIGITS(DHARPR) PERD,
	DHCOMP, 
	DHCURR,
	BVCOMP, 
	BVCLAS,
	BVCUST||' - '||RTRIM(BVNAME) CUST,
	DIGLCD||' - '||RTRIM(G.A30) GLCODE, 
	DIREAS||' - '||RTRIM(R.A30) REAS,
	DHINCR, 
	DIPART||' - '||RTRIM(DIDESC) PARTDESCR,
	COALESCE(AWGLED, AVGLED) GLED,
	COALESCE(AWMAJG,AVMAJG)||' - '||RTRIM(BQDES) MAJG,
	COALESCE(AWMING, AVMING)||' - '||RTRIM(BRDES)  MING,
	DIMAJR||' - '||SMJ.BSDES1 SMAJ,
	DIMINR||' - '||SMN.BSDES1 SMIN, 
	CASE WHEN DIGITS(DHARYR)||DIGITS(DHARPR) <= '1306' THEN HYPNEW ELSE  HYPOLD END HYPACCT, 
	DIGITS(ZWSAL#) CMSGL,
	SUBSTR(DIGITS(ZWSAL#),7,4) PRIME,
	COUNT(DILIN#) AS LINECOUNT, 
	SUM(DIQTSH*CASE DHINCR WHEN 'C' THEN -1 ELSE 1 END) DIQTSH,
	SUM(DICTEX*CASE DHINCR WHEN 'C' THEN -1 ELSE 1 END*CASE WHEN DHCOMP = 66 THEN RATE ELSE 1 END) HCTEX,
	SUM(DITDIS*CASE DHINCR WHEN 'C' THEN -1 ELSE 1 END*CASE WHEN DHCURR = 'CA' THEN RATE ELSE 1 END) DIS,
	SUM(DIEXT*CASE DHINCR WHEN 'C' THEN -1 ELSE 1 END*CASE WHEN DHCURR = 'CA' THEN RATE ELSE 1 END) EXT
FROM
	LGDAT.OIH
	LEFT OUTER JOIN LGDAT.OID ON
		DIINV# = DHINV#
	LEFT OUTER JOIN LGDAT.CODE G ON
		G.A2 = 'EE' AND
		LTRIM(RTRIM(G.A9)) = DIGLCD
	LEFT OUTER JOIN LGDAT.CODE R ON
		R.A2 = 'RS' AND
		LTRIM(RTRIM(R.A9)) = DIREAS
	LEFT OUTER JOIN LGDAT.CUST ON
		BVCUST = DHBCS#
	LEFT OUTER JOIN LGDAT.STKA ON
		V6PART = DIPART AND
		V6PLNT = DHPLNT
	LEFT OUTER JOIN LGDAT.STKMM ON
		AVPART = DIPART
	LEFT OUTER JOIN LGDAT.STKMP ON
		AWPART = DIPART
	LEFT OUTER JOIN LGDAT.PLNT ON
		YAPLNT = DHPLNT
	LEFT OUTER JOIN LGDAT.GLIE ON
		Y1PLNT = DHPLNT AND
		Y1GLEC = COALESCE(AVGLED, AWGLED)
	LEFT OUTER JOIN LGDAT.MAJG ON
		BQGRP = COALESCE(AWMAJG, AVMAJG)
	LEFT OUTER JOIN LGDAT.MMGP ON
		BRGRP = BQGRP AND
		BRMGRP = COALESCE(AVMING, AWMING)
	LEFT OUTER JOIN LGDAT.ICSTM ON
		CGPART = DIPART AND
		CGPLNT = DHPLNT
	LEFT OUTER JOIN LGDAT.ICSTP ON
		CHPART = DIPART AND
		CHPLNT = DHPLNT
	LEFT OUTER JOIN LGDAT.ICSTR ON
		Y0PART = DIPART AND
		Y0PLNT = DHPLNT
	LEFT OUTER JOIN LGDAT.ARMASC ON
		ZWCOMP = BVCOMP AND
		ZWKEY1 = BVARCD AND
		ZWKEY2 = DIGLCD
	LEFT OUTER JOIN LGPGM.CMSTOHYP ON
		CMSGL = ZWSAL#
	LEFT OUTER JOIN LGDAT.MMSL SMN ON
		SMN.BSMJCD = DIMAJR AND
		SMN.BSMNCD = DIMINR
	LEFT OUTER JOIN LGDAT.MMSL SMJ ON
		SMJ.BSMJCD = DIMAJR AND
		SMJ.BSMNCD = ''
	LEFT OUTER JOIN COGNOS.EXCHANGE ON
		FROMCUR = 'CA' AND
		TOCUR = 'US' AND
		ARYEAR = DHARYR AND
		ARPERIOD = DHARPR
WHERE
	DHARYR in  (7,8,9,10,11,12,13,14)
GROUP BY
	DIGITS(DHARYR)||DIGITS(DHARPR),
	DHCOMP, 
	DHCURR,
	BVCOMP, 
	BVCLAS,
	BVCUST||' - '||RTRIM(BVNAME),
	DIGLCD||' - '||RTRIM(G.A30), 
	DIREAS||' - '||RTRIM(R.A30),
	DHINCR, 
	DIPART||' - '||RTRIM(DIDESC),
	COALESCE(AWGLED, AVGLED),
	COALESCE(AWMAJG,AVMAJG)||' - '||RTRIM(BQDES),
	COALESCE(AWMING, AVMING)||' - '||RTRIM(BRDES),
	DIMAJR||' - '||SMJ.BSDES1,
	DIMINR||' - '||SMN.BSDES1,
	CASE WHEN DIGITS(DHARYR)||DIGITS(DHARPR) <= '1306' THEN HYPNEW ELSE  HYPOLD END, 
	DIGITS(ZWSAL#),
	SUBSTR(DIGITS(ZWSAL#),7,4)