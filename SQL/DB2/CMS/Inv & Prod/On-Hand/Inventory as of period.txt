SELECT
	'STKT' AS SRCE,
	YACOMP||DIGITS(Y1INVA) ACCT,
	BYPLNT, BYPART, V6STAT, BYSTOK, 
	SUM(BYQTY*CASE BYACTN WHEN 'I' THEN -1 ELSE 1 END) AS QTY,
	SUM(BYQTY*CASE BYACTN WHEN 'I' THEN -1 ELSE 1 END*COALESCE(CGSTCS, CHSTCS, Y0STCS)) AS STCS
FROM
	LGDAT.STKT
	INNER JOIN LGDAT.STKA ON
		V6PART = BYPART AND
		V6PLNT = BYPLNT
	LEFT OUTER JOIN LGDAT.ICSTP ON
		CHPART = BYPART AND
		CHPLNT = BYPLNT
	LEFT OUTER JOIN LGDAT.ICSTM ON
		CGPART = BYPART AND
		CGPLNT = BYPLNT
	LEFT OUTER JOIN LGDAT.ICSTR ON
		Y0PART = BYPART AND
		Y0PLNT = BYPLNT
	LEFT OUTER JOIN LGDAT.STKMM ON
		AVPART = BYPART 
	LEFT OUTER JOIN LGDAT.STKMP ON
		AWPART = BYPART
	LEFT OUTER JOIN LGDAT.GLIE A ON
		Y1GLEC = COALESCE(AVGLED, AWGLED) AND
		Y1PLNT = BYPLNT
	LEFT OUTER JOIN LGDAT.PLNT L ON
		YAPLNT = BYPLNT		
WHERE
	BYPLNT = '152' AND
	BYFSYY = 2014
GROUP BY
	YACOMP||DIGITS(Y1INVA),
	BYPLNT, BYPART, V6STAT, BYSTOK

UNION ALL

SELECT
	'STKB' AS SRCE,
	YACOMP||DIGITS(Y1INVA) ACCT,
	BXPLNT,
	BXPART,
	V6STAT,
	BXSTOK,
	BXQTOH,
	COALESCE(CGSTCS, CHSTCS, Y0STCS)*BXQTOH STCS
FROM
	LGDAT.STKB
	INNER JOIN LGDAT.STKA ON
		V6PART = BXPART AND
		V6PLNT = BXPLNT
	LEFT OUTER JOIN LGDAT.ICSTP ON
		CHPART = BXPART AND
		CHPLNT = BXPLNT
	LEFT OUTER JOIN LGDAT.ICSTM ON
		CGPART = BXPART AND
		CGPLNT = BXPLNT
	LEFT OUTER JOIN LGDAT.ICSTR ON
		Y0PART = BXPART AND
		Y0PLNT = BXPLNT
	LEFT OUTER JOIN LGDAT.STKMM ON
		AVPART = BXPART 
	LEFT OUTER JOIN LGDAT.STKMP ON
		AWPART = BXPART
	LEFT OUTER JOIN LGDAT.GLIE A ON
		Y1GLEC = COALESCE(AVGLED, AWGLED) AND
		Y1PLNT = BXPLNT
	LEFT OUTER JOIN LGDAT.PLNT L ON
		YAPLNT = BXPLNT		
WHERE
	BXPLNT = '152' AND
	BXPART <> '' AND
	COALESCE(CGSTCS, CHSTCS, Y0STCS)*BXQTOH<> 0

