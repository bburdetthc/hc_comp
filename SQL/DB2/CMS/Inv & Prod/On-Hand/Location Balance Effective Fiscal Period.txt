SELECT
	YACOMP||DIGITS(Y1INVA) ACCT, 
	SUBSTR(YACOMP||DIGITS(Y1INVA),7,4) PRIME,
	AZGROP||' - '||RTRIM(BQ1TITL) FGRP,
	BYPLNT PLANT, 
	BYPART,
	RTRIM(COALESCE(AVDES1,AWDES1,'')) DESCR, 
	CHAR(COALESCE(AVCDAT,AWCDAT)) CREATE_DATE,
	BYSTOK||' - '||RTRIM(AXLOCN) ILOC,
	COALESCE(AWGLDC, AVGLCD) GLCODE,
	COALESCE(AWGLED, AVGLED) INVCODE,
	COALESCE(AWMAJG,AVMAJG)||' - '||RTRIM(BQDES) MAJG,
	COALESCE(AWMING, AVMING)||' - '||RTRIM(BRDES)  MING,
	COALESCE(AWMAJS, AVMAJS)||' - '||RTRIM(SMJ.BSDES1) MAJS,
	COALESCE(AWMINS, AVMINS)||' - '||RTRIM(SMN.BSDES1) MINS,
	V6STAT STATUS, 
	V6RPLN PROCUREMENT,
	QTOH QTOH,
	FRI COST_RECORD,
	FST COST_DATE,
	TOT COST,
	QTOH*COALESCE(TOT,0) EXTCOST,
	RTRIM(AZFUT2) CURR,
	RATE EXCH,
	QTOH*COALESCE(TOT,0)*RATE EXTCOST_USD
FROM
	(
	SELECT
		BYPLNT, BYPART, BYSTOK, SUM(QTOH) QTOH
	FROM
		(
		SELECT
			BYPLNT, BYPART, BYSTOK,
			-SUM(BYQTY*CASE BYACTN WHEN 'I' THEN -1 ELSE 1 END) QTOH
		FROM
			LGDAT.STKT STKT
		WHERE
			BYFSYY||DIGITS(BYFSPR) >= '201511'
		GROUP BY
			SUBSTR(BYFSYY,3,2)||DIGITS(BYFSPR), 
			BYPLNT, BYPART, BYSTOK,
			CASE STKT.BYSRC 
				WHEN 'OE' THEN  'OE'||UPPER(SUBSTRING(BYDREF,1,3)) 
				WHEN 'INV' THEN 'INV'||RTRIM(BYREAS)
				ELSE BYSRC 
			END

		UNION ALL

		SELECT
			BXPLNT BYPLNT, BXPART BYPART, BXSTOK BYSTOK,
			SUM(BXQTOH) QTOH
		FROM
			LGDAT.STKB
		WHERE
			BXPART <> '' AND
			BXQTOH<> 0
		GROUP BY
			BXPLNT, BXPART, BXSTOK
		) X
	GROUP BY
		BYPLNT, BYPART, BYSTOK
	) BEFP ----BALANCE EFFECTIVE FISCAL PERIOD
LEFT OUTER JOIN LGDAT.STKA ON
	V6PART = BYPART AND
	V6PLNT = BYPLNT
LEFT OUTER JOIN LGDAT.STKMM ON
	AVPART = BYPART
LEFT OUTER JOIN LGDAT.STKMP ON
	AWPART = BYPART
LEFT OUTER JOIN LGDAT.PLNT ON
	YAPLNT = BYPLNT
LEFT OUTER JOIN LGDAT.GLIE ON
	Y1PLNT = BYPLNT AND
	Y1GLEC = COALESCE(AVGLED, AWGLED)
LEFT OUTER JOIN LGDAT.MAJG ON
	BQGRP = COALESCE(AWMAJG, AVMAJG)
LEFT OUTER JOIN LGDAT.MMGP ON
	BRGRP = BQGRP AND
	BRMGRP = COALESCE(AVMING, AWMING)
LEFT OUTER JOIN LGDAT.MMSL SMN ON
	SMN.BSMJCD = COALESCE(AVMAJS, AWMAJS) AND
	SMN.BSMNCD = COALESCE(AVMINS, AWMINS)
LEFT OUTER JOIN LGDAT.MMSL SMJ ON
	SMJ.BSMJCD = COALESCE(AVMAJS, AWMAJS) AND
	SMJ.BSMNCD = ''
LEFT OUTER JOIN LGDAT.STKR ON
	AXSTKL = BYSTOK
LEFT OUTER JOIN LGDAT.MAST ON
	AZCOMP||DIGITS(AZGL#1)||DIGITS(AZGL#2) = YACOMP||DIGITS(Y1INVA)
LEFT OUTER JOIN LGDAT.FGRP ON
	BQ1GRP = AZGROP
LEFT OUTER JOIN FANALYSIS.FFCRET ON
	FCUR = AZFUT2 AND
	TCUR = 'US' AND
	RTYP = 'ME' AND
	PERD = '1510'
LEFT OUTER JOIN QGPL.FFICSTX ON
	PART = BYPART AND
	PLNT = BYPLNT AND
	FST < '2015-09-30' AND
	TST > '2015-09-30'
FETCH FIRST 10 ROWS ONLY