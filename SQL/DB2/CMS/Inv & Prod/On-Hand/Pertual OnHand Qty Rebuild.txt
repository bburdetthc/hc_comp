SELECT
	YACOMP||DIGITS(Y1INVA) ACCT, 
	SUBSTR(YACOMP||DIGITS(Y1INVA),7,4) PRIME,
	BYPLNT PLANT, 
	BYPART PART, 
	BYSTOK ILOC,
	SUM(QTOH) QTOH
FROM
(
SELECT
	BYPLNT, BYPART, BYSTOK,
	-SUM(BYQTY*CASE BYACTN WHEN 'I' THEN -1 ELSE 1 END) QTOH
FROM
	LGDAT.STKT STKT
WHERE
	BYFSYY||DIGITS(BYFSPR) >= '201504'
GROUP BY
	SUBSTR(BYFSYY,3,2)||DIGITS(BYFSPR), 
	BYPLNT, BYPART, BYSTOK,
	CASE STKT.BYSRC 
		WHEN 'OE' THEN  'OE'||UPPER(SUBSTRING(BYDREF,1,3)) 
		WHEN 'INV' THEN 'INV'||RTRIM(BYREAS)
		ELSE BYSRC 
	END

UNION ALL

SELECT
	BXPLNT BYPLNT, BXPART BYPART, BXSTOK BYSTOK,
	SUM(BXQTOH) QTOH
FROM
	LGDAT.STKB
WHERE
	BXPART <> '' AND
	BXQTOH<> 0
GROUP BY
	BXPLNT, BXPART, BXSTOK
) X
LEFT OUTER JOIN LGDAT.STKMM ON
	AVPART = BYPART
LEFT OUTER JOIN LGDAT.STKMP ON
	AWPART = BYPART
LEFT OUTER JOIN LGDAT.PLNT ON
	YAPLNT = BYPLNT
LEFT OUTER JOIN LGDAT.GLIE ON
	Y1PLNT = BYPLNT AND
	Y1GLEC = COALESCE(AVGLED, AWGLED)
GROUP BY
	YACOMP||DIGITS(Y1INVA),
	SUBSTR(YACOMP||DIGITS(Y1INVA),7,4),
	BYPLNT, BYPART, 
	BYSTOK
HAVING ROUND(SUM(QTOH),5) <>0