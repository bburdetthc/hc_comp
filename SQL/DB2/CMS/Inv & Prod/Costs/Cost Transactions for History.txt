---------------------------------------------------------------------------------------------------------------------
--PULL ALL COST CHANGES WHERE THE CHANGE DATE & PART ARE IN THE TARGET TRANSACTION DATES & PARTS
--PUT THEM IN A TEMP TABLE TO CHECK FOR AGGREGATION METHOD IS OK AND WHERE OLD COST = 0 UPDATE TO PREVIOUS NEW COST
--GRAB ALL PREVIOUS COST RUN FOR ITEMS WHERE THE OLD IS -0- IN THE INITIAL LIST AND PICK THE MAX DATE/TIME
--APPLY THAT NEW COST TO THE OLD COST IN THE TEMP FILE
--THEN APPLY THE TEMP FILE COST LISTING TO THE TARGET TRANSACTIONS
---------------------------------------------------------------------------------------------------------------------

--DECLARE GLOBAL TEMPORARY TABLE CT(PART CHAR(20), PLNT CHAR(4), DT CHAR(10), TM CHAR(8), NEW FLOAT, CHK1 INT, CHK2 INT, RID INT)

/*
INSERT INTO
	QTEMP.CT
SELECT
	JHPART, JHPLNT, CHAR(JHDATE), CHAR(JHTIME), SUM(JHTOTN),
	--if either of the following fields are greater than one then do not use. the agg eliminates duplicate entries per timestamp
	SUM(CASE JHTOTO WHEN 0 THEN 0 ELSE 1 END),
	SUM(CASE JHTOTN WHEN 0 THEN 0 ELSE 1 END), 0
FROM
	LGDAT.ICSTT
	INNER JOIN
	(
	SELECT DISTINCT
		BYPART, BYPLNT
	FROM
		LGDAT.STKT
	WHERE
		BYFSYY = 2014 AND
		BYFSPR = 3
	) X ON
		BYPART = JHPART AND
		BYPLNT = JHPLNT AND
		JHDATE >= '2014-03-01' AND
		JHDATE < '2014-04-01' AND
		JHCTYP = 'S'
GROUP BY
	JHPART, JHPLNT, CHAR(JHDATE), CHAR(JHTIME)
*/

/*
INSERT INTO 
	QTEMP.CT
*/

SELECT
	PART, PLNT, CHAR(JHDATE), CHAR(JHTIME), SUM(JHTOTN),
	--if either of the following fields are greater than one then do not use
	SUM(CASE JHTOTO WHEN 0 THEN 0 ELSE 1 END),
	SUM(CASE JHTOTN WHEN 0 THEN 0 ELSE 1 END), 0
FROM
	(
		--this listing needs to pull the max stamp where the stamp is less than the existing min stamp
		SELECT
			PART, PLNT, DT, TM, MAX(CHAR(JHDATE)||CHAR(JHTIME)) SSTMP
		FROM
			QTEMP.CT
			INNER JOIN LGDAT.ICSTT ON
				JHPART = PART AND
				JHPLNT = PLNT AND
				JHCTYP = 'S' AND
				CHAR(JHDATE)||CHAR(JHTIME) < DT||TM
		GROUP BY
			PART, PLNT, DT, TM
	) X
	INNER JOIN LGDAT.ICSTT ON
		JHPART = PART AND
		JHPLNT = PLNT AND
		JHCTYP = 'S' AND
		CHAR(JHDATE)||CHAR(JHTIME) = SSTMP
GROUP BY
	PART, PLNT, CHAR(JHDATE), CHAR(JHTIME)


/*
MERGE INTO QTEMP.CT CT 
	USING (SELECT CT.*, ROW_NUMBER() OVER (PARTITION BY PART, PLNT ORDER BY PART, PLNT, DT, TM) NRID FROM QTEMP.CT CT) RN
	ON
		CT.PART = RN.PART AND
		CT.PLNT = RN.PLNT AND
		CT.DT = RN.DT AND
		CT.TM = RN.TM
WHEN MATCHED
	THEN UPDATE SET
		(CT.RID) = (RN.NRID)
*/

--SELECT * FROM QTEMP.CT

--DROP TABLE QTEMP.CT