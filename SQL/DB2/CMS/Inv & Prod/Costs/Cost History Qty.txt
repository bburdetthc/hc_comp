--DECLARE GLOBAL TEMPORARY TABLE CT(PART CHAR(20), PLNT CHAR(4), DT CHAR(10), TM CHAR(8), QTY FLOAT, NEW FLOAT, CHK1 INT, CHK2 INT, RID INT)
--DECLARE GLOBAL TEMPORARY TABLE OT(PART CHAR(20), PLNT CHAR(4), DT CHAR(10), TM CHAR(8), QTY FLOAT, NEW FLOAT, CHK1 INT, CHK2 INT, RID INT)

--INSERT ALL THE KNOWN ICSTT ROLL ITEMS TO 'CT' TEMP FILE

/*
INSERT INTO
	QTEMP.CT
SELECT
	JHPART, JHPLNT, CHAR(JHDATE), CHAR(JHTIME), JHOHQT, SUM(JHTOTN),
	--if either of the following fields are greater than one then do not use. the agg eliminates duplicate entries per timestamp
	SUM(CASE JHTOTO WHEN 0 THEN 0 ELSE 1 END),
	SUM(CASE JHTOTN WHEN 0 THEN 0 ELSE 1 END), 0
FROM
	LGDAT.ICSTT
WHERE
	JHDATE >= '2014-04-27' AND
	JHDATE <= '2014-04-28' AND
	JHCTYP = 'S' AND
	JHUSER = 'JDEARMENT' AND
	JHOHQT <> 0
GROUP BY
	JHPART, JHPLNT, CHAR(JHDATE), CHAR(JHTIME), JHOHQT
*/

--now need to pull that last roll before the ones currently listed in CT since the "old" cost field is not accurate

/*
INSERT INTO 
	QTEMP.OT
SELECT
	PART, PLNT, CHAR(JHDATE), CHAR(JHTIME), JHOHQT, SUM(JHTOTN),
	--if either of the following fields are greater than one then do not use
	SUM(CASE JHTOTO WHEN 0 THEN 0 ELSE 1 END),
	SUM(CASE JHTOTN WHEN 0 THEN 0 ELSE 1 END), 0
FROM
	(
		--this listing needs to pull the max stamp where the stamp is less than the existing min stamp
		SELECT
			PART, PLNT, MAX(CHAR(JHDATE)||CHAR(JHTIME)) SSTMP
		FROM
			(SELECT PART, PLNT, MIN(DT||TM) MINS FROM QTEMP.CT GROUP BY PART, PLNT) X
			INNER JOIN LGDAT.ICSTT ON
				JHPART = X.PART AND
				JHPLNT = X.PLNT AND
				JHCTYP = 'S' AND
				CHAR(JHDATE)||CHAR(JHTIME) < X.MINS
		GROUP BY
			PART, PLNT
	) X
	INNER JOIN LGDAT.ICSTT ON
		JHPART = PART AND
		JHPLNT = PLNT AND
		JHCTYP = 'S' AND
		CHAR(JHDATE)||CHAR(JHTIME) = SSTMP
GROUP BY
	PART, PLNT, CHAR(JHDATE), CHAR(JHTIME), JHOHQT
*/

--SELECT CT.*, ROW_NUMBER() OVER (PARTITION BY PART, PLNT ORDER BY PART, PLNT, DT, TM) NRID FROM QTEMP.CT CT FETCH FIRST 50 ROWS ONLY


/*
MERGE INTO QTEMP.CT CT 
	USING (SELECT CT.*, ROW_NUMBER() OVER (PARTITION BY PART, PLNT ORDER BY PART, PLNT, DT, TM) NRID FROM QTEMP.CT CT) RN
	ON
		CT.PART = RN.PART AND
		CT.PLNT = RN.PLNT AND
		CT.DT = RN.DT AND
		CT.TM = RN.TM
WHEN MATCHED
	THEN UPDATE SET
		(CT.RID) = (RN.NRID)
*/


/*
SELECT 
	T.PART, T.PLNT, F.DT, F.TM, F.NEW, T.DT, T.TM, T.NEW, T.QTY
FROM
	QTEMP.CT T
	LEFT OUTER JOIN QTEMP.CT F ON
		F.PART = T.PART AND
		F.PLNT = T.PLNT AND
		F.RID = T.RID - 1
WHERE
	IFNULL(F.PART,'X')='X' AND
	T.QTY <> 0 AND
	T.DT >= '2014-04-27'
FETCH FIRST 500 ROWS ONLY
*/

--DROP TABLE QTEMP.CT
