SELECT
	BYPLNT, BYPART, BYSRC, COALESCE(BYREAS||' - '||R3DESC,RTRIM(BYSRC)) REASC, BYQTY, SUBSTR(DIGITS(BYFSYY),3,2)||DIGITS(BYFSPR) PERD,
	SUBSTR(DIGITS(Y1INVA),5,4) PRIME, COALESCE(SUBSTR(DIGITS(BQ0ACCT),7,4),
	SUBSTR(DIGITS(Y1PADJ),5,4)) EXPACCT,
	BQGRP||' - '||RTRIM(BQDES) AS MAJG,
	BRMGRP||' - '||RTRIM(BRDES) AS MING,
	CASE V6RPLN WHEN 1 THEN COALESCE(AODEPT||' - '||AORESC,'NO RESC') WHEN 2 THEN 'PURCH' WHEN 3 THEN 'TRANSF' END PROCU,
	BYQTY*CASE BYACTN WHEN 'I' THEN -1 ELSE 1 END BYQTY,
	-BYQTY*CASE BYACTN WHEN 'I' THEN -1 ELSE 1 END*COALESCE(FCOST, CGSTCS, CHSTCS, Y0STCS) COST
FROM
	LGDAT.STKT
	LEFT OUTER JOIN QGPL.FFCOSTEFFD ON
		PART = BYPART AND
		PLNT = BYPLNT AND
		CHAR(FDT)||CHAR(FTM) <= CHAR(BYSDAT)||CHAR(BYSTIM) AND
		CHAR(TDT)||CHAR(TTM) >= CHAR(BYSDAT)||CHAR(BYSTIM)
	LEFT OUTER JOIN LGDAT.ICSTM ON
		CGPART = BYPART AND
		CGPLNT = BYPLNT
	LEFT OUTER JOIN LGDAT.ICSTP ON
		CHPART = BYPART AND
		CHPLNT = BYPLNT
	LEFT OUTER JOIN LGDAT.ICSTR ON
		Y0PART = BYPART AND
		Y0PLNT = BYPLNT
	LEFT OUTER JOIN LGDAT.STKMM ON
		AVPART = BYPART
	LEFT OUTER JOIN LGDAT.STKMP ON
		AWPART = BYPART
	LEFT OUTER JOIN LGDAT.GLIE ON
		Y1PLNT = BYPLNT AND
		Y1GLEC = COALESCE(AWGLED, AVGLED)
	LEFT OUTER JOIN LGDAT.STKA ON
		V6PART = BYPART AND
		V6PLNT = BYPLNT
	LEFT OUTER JOIN LGDAT.METHDR ON
		AOPART = BYPART AND
		AOPLNT = BYPLNT AND
		AOSEQ# = 10
	LEFT OUTER JOIN LGDAT.MMGP ON
		BRGRP = COALESCE(AVMAJG, AWMAJG) AND
		BRMGRP = COALESCE(AVMING, AWMING)
	LEFT OUTER JOIN LGDAT.MAJG ON
		BQGRP = COALESCE(AVMAJG, AWMAJG)
	LEFT OUTER JOIN LGDAT.MARC ON
		BQ0PLNT = BYPLNT AND
		BQ0REAS = BYREAS AND
		BQ0TYPE = CASE BYACTN WHEN 'I' THEN 1 ELSE 2 END
	LEFT OUTER JOIN LGDAT.TREA ON
		R3REAS = BYREAS
WHERE
	BYFSYY = 2014 AND
	BYFSPR >= 6 AND
	RTRIM(BYSRC) IN ('PHY','INV') AND
	RTRIM(BYSRC)||RTRIM(BYREAS) NOT IN ('INVTRA','INV') AND
	BYQTY <> 0 AND
	BYPLNT = '152'
