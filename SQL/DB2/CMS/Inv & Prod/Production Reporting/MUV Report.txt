---------------------------------------MATERIAL USAGE VARIANCE REPORTING FOR A GIVE PERIOD ALL PLANTS--------------------------------------
--SETUP A FILE THAT HOLD THE WORK ORDERS TO BE REPORTED ON FOR A GIVEN PERIOD									--
--PULL THE METHOD BOMS, THE WORK ORDER BOMS, THE ACTUAL BOMS, AND THEN CREATE A LIST OF ALL UNIQUE COMPONENTS USED FOR EACH WORK ORDER	--
--THEN DO LEFT JOINS BACK TO EACH METHOD, JOB & ACTUAL BOMS SO THEY ARE IN ADJACENT COLUMNS AND CAN BE COMPARED				--
--																				--
--THE ROUTING EFFICIENCY FACTOR MUST BE USED TO GET TO THE STANDARD & JOB BOMS									--
-------------------------------------------------------------------------------------------------------------------------------------------

--NOT SURE HOW THESE TEMP TABLES WORK, BUT ONLY THE CURRENT SESSION SHOULD HAVE ACCESS AND WANT TO PREVENT RUNNING MORE THAN ONE SO THEY DONT OVERLAP

--DECLARE GLOBAL TEMPORARY TABLE WPP (WRKO CHAR(10), PART CHAR(20), PLNT CHAR(3), STAT CHAR(1), SEQ INT, PERD CHAR(4), GQTY FLOAT, SQTY FLOAT)
--DECLARE GLOBAL TEMPORARY TABLE JBOM (WRKO CHAR(10), PART CHAR(20), SEQ INT, MTLP CHAR(20), UNIT CHAR(15), QTY FLOAT)
--DECLARE GLOBAL TEMPORARY TABLE MBOM (WRKO CHAR(10), PART CHAR(20), SEQ INT, MTLP CHAR(20), UNIT CHAR(15), QTY FLOAT)
--DECLARE GLOBAL TEMPORARY TABLE RBOM (WRKO CHAR(10), PART CHAR(20), SEQ INT, MTLP CHAR(20), UNIT CHAR(15), QTY FLOAT)
--DECLARE GLOBAL TEMPORARY TABLE UBOM (WRKO CHAR(10), PART CHAR(20), SEQ INT, MTLP CHAR(20), UNIT CHAR(15))

/*
INSERT INTO
	QTEMP.WPP
SELECT
	IXWRKO, IXPART, SUBSTR(IXDEPT,1,3) AS PLNT,			
	CASE IFNULL(H.DNPLNT,'X') WHEN 'X' THEN 'C' ELSE 'H' END STAT,
	IXSEQ#, DIGITS(IXFSYY)||DIGITS(IXFSPP) AS PERD,
	SUM(IXQTY), SUM(IXSCRP)
FROM
	LGDAT.PRTRAN
	LEFT OUTER JOIN LGDAT.CJOBH C ON					
		C.DNJOB = IXWRKO				
	LEFT OUTER JOIN LGDAT.HJOBH H ON					
		H.DNJOB = IXWRKO				
WHERE						
	IXFSYY = 14 AND					
	IXFSPP = 1 AND					
	IXPART <> '' AND
	IXWRKO <> ''
GROUP BY
	IXWRKO, IXPART, SUBSTR(IXDEPT,1,3), 					
	CASE IFNULL(H.DNPLNT,'X') WHEN 'X' THEN 'C' ELSE 'H' END,
	IXSEQ#, DIGITS(IXFSYY)||DIGITS(IXFSPP)
HAVING
	SUM(IXQTY+IXSCRP)<>0
*/


/*
INSERT INTO
	QTEMP.JBOM
SELECT 
 	W.WRKO, W.PART, W.SEQ,
	COALESCE(C.EFMTLP, H.EFMTLP) MTLP,
	COALESCE(C.EFUNIT, H.EFUNIT)||' '||V6UNTI AS JOB_STKA,
 	SUM(
		CASE COALESCE(C.EFRQBY, H.EFRQBY) WHEN 'B' THEN -1 ELSE 1 END*
		COALESCE(C.EFQPPC, H.EFQPPC)*
		CASE COALESCE(C.EFQTYM, H.EFQTYM,0) WHEN 0 THEN FLOAT(0) ELSE 1/COALESCE(C.EFQTYM, H.EFQTYM) END/
		(1-FLOAT(COALESCE(C.EFSCRP, H.EFSCRP))/100)*IFNULL(CNV1,1)/IFNULL(CNV2,1)
	) AS SCRPQTY
FROM 
	QTEMP.WPP W
 	LEFT OUTER JOIN LGDAT.CJOBDM C ON
		C.EFJOB# = W.WRKO AND
		C.EFSEQ# = W.SEQ
	LEFT OUTER JOIN LGDAT.HJOBDM H ON
		H.EFJOB# = W.WRKO AND
		H.EFSEQ# = W.SEQ
   	LEFT OUTER JOIN LGDAT.STKA A ON
  		V6PART = COALESCE(C.EFMTLP, H.EFMTLP) AND
  		V6PLNT = W.PLNT
 	LEFT OUTER JOIN 
 	(
  		SELECT 
			IHPART AS PART, IHUNT1 AS UNT1, IHUNT2 AS UNT2, IHCNV1 AS CNV1, IHCNV2 AS CNV2
  		FROM 
			LGDAT.PUNIT PUNIT
  		WHERE 
			PUNIT.IHPART='&&GLOBAL'
  		UNION ALL
  		SELECT 
			IHPART AS PART, IHUNT2 AS UNT1, IHUNT1 AS UNT2, IHCNV2 AS CNV1, IHCNV1 AS CNV2
  		FROM 
			LGDAT.PUNIT PUNIT
  		WHERE 
			PUNIT.IHPART='&&GLOBAL'
 	) X ON
  		V6UNTI = X.UNT1 AND
  		COALESCE(C.EFUNIT, H.EFUNIT) = X.UNT2
WHERE
	COALESCE(C.EFJOB#,H.EFJOB#,'X') <> 'X'
GROUP BY
	W.WRKO, W.PART, W.SEQ, 
	COALESCE(C.EFMTLP, H.EFMTLP), 
	COALESCE(C.EFUNIT, H.EFUNIT)||' '||V6UNTI
*/

/*
INSERT INTO
	QTEMP.MBOM
SELECT 
 	W.WRKO, W.PART, W.SEQ, 
	AQMTLP, 
	AQUNIT||' '||V6UNTI AS JOB_STKA,
 	SUM(
		CASE AQRQBY WHEN 'B' THEN -1 ELSE 1 END*
		AQQPPC/AQQTYM/(1-FLOAT(AQSCRP)/100)*IFNULL(CNV1,1)/IFNULL(CNV2,1)
	) AS SCRPQTY
FROM 
	QTEMP.WPP W
 	INNER JOIN LGDAT.METHDM ON
		AQPART = W.PART AND
		AQPLNT = W.PLNT AND
		AQSEQ# = W.SEQ
   	LEFT OUTER JOIN LGDAT.STKA A ON
  		V6PART = AQMTLP AND
  		V6PLNT = W.PLNT
 	LEFT OUTER JOIN 
 	(
  		SELECT 
			IHPART AS PART, IHUNT1 AS UNT1, IHUNT2 AS UNT2, IHCNV1 AS CNV1, IHCNV2 AS CNV2
  		FROM 
			LGDAT.PUNIT PUNIT
  		WHERE 
			PUNIT.IHPART='&&GLOBAL'
  		UNION ALL
  		SELECT 
			IHPART AS PART, IHUNT2 AS UNT1, IHUNT1 AS UNT2, IHCNV2 AS CNV1, IHCNV1 AS CNV2
  		FROM 
			LGDAT.PUNIT PUNIT
  		WHERE 
			PUNIT.IHPART='&&GLOBAL'
 	) X ON
  		V6UNTI = X.UNT1 AND
  		AQUNIT = X.UNT2
GROUP BY
	W.WRKO, W.PART, W.SEQ, 
	AQMTLP, 
	AQUNIT||' '||V6UNTI
*/


/*
INSERT INTO
	QTEMP.RBOM
SELECT
	X.WRKO, X.PART, X.SEQ, X.UIMTLP, X.JOB_STKA, QTY/(W.GQTY+W.SQTY) AS QTY
FROM
	(
SELECT 
 	W.WRKO, W.PART, W.SEQ, 
	UIMTLP, 
	UIUNMT||' '||V6UNTI AS JOB_STKA,
	SUM(UITQTY*CASE UIRQBY WHEN 'B' THEN -1 ELSE 1 END*IFNULL(CNV1,1)/IFNULL(CNV2,1)) AS QTY
FROM 
	QTEMP.WPP W
	--somehow the prtran file will have to be linked to the rprm file in order to filter down the fiscal period
 	INNER JOIN LGDAT.RPRM ON
		UIJOB# = W.WRKO AND
		UIPART = W.PART AND
		SUBSTR(UIDEPT,1,3) = W.PLNT AND
		UISEQ# = W.SEQ AND
		UIMSEQ = 0
	INNER JOIN LGDAT.RPRH ON
		UIBTID = NWBTID AND
		DIGITS(NWFSYY)||DIGITS(NWFSPP)=W.PERD
   	LEFT OUTER JOIN LGDAT.STKA A ON
  		V6PART = UIMTLP AND
  		V6PLNT = W.PLNT
 	LEFT OUTER JOIN 
 	(
  		SELECT 
			IHPART AS PART, IHUNT1 AS UNT1, IHUNT2 AS UNT2, IHCNV1 AS CNV1, IHCNV2 AS CNV2
  		FROM 
			LGDAT.PUNIT PUNIT
  		WHERE 
			PUNIT.IHPART='&&GLOBAL'
  		UNION ALL
  		SELECT 
			IHPART AS PART, IHUNT2 AS UNT1, IHUNT1 AS UNT2, IHCNV2 AS CNV1, IHCNV1 AS CNV2
  		FROM 
			LGDAT.PUNIT PUNIT
  		WHERE 
			PUNIT.IHPART='&&GLOBAL'
 	) X ON
  		V6UNTI = X.UNT1 AND
  		UIUNMT = X.UNT2
GROUP BY
	W.WRKO, W.PART, W.SEQ, 
	UIMTLP, 
	UIUNMT||' '||V6UNTI
HAVING SUM(UIRQTY)<>0
) X
	INNER JOIN QTEMP.WPP W ON
		W.WRKO = X.WRKO AND
		W.PART = X.PART AND
		W.SEQ = X.SEQ
		
	
*/


/*
INSERT INTO
	QTEMP.UBOM

SELECT
	WRKO , PART , SEQ , MTLP , UNIT
FROM
	QTEMP.JBOM

UNION

SELECT
	WRKO , PART , SEQ , MTLP , UNIT
FROM
	QTEMP.MBOM

UNION

SELECT
	WRKO , PART , SEQ , MTLP , UNIT
FROM
	QTEMP.RBOM
*/

/*
SELECT
	W.PERD,
	W.PLNT, 
	COALESCE(CR.EDDEPT, HR.EDDEPT) AS SCHDEPT, 
	COALESCE(CR.EDRESC, HR.EDRESC) AS SCHRESC,
	W.WRKO, W.PART, W.SEQ, W.GQTY, W.SQTY,
	U.MTLP, 
	RTRIM(U.MTLP)||' - '||COALESCE(AWDES1,AVDES1) MTLPD,
	COALESCE(AVMAJG, AWMAJG)||' - '||BQDES AS MAJG,
	BRMGRP||' - '||BRDES AS MING,
	U.UNIT,
	COALESCE(CGSTCS, CHSTCS, Y0STCS) 													STCS,
	COALESCE(CGSTCS, CHLUC+CHSFC,Y0STCS) 												LUC,
	FLOAT(COALESCE(CR.EDEFF, HR.EDEFF))/100 												JEFF, 
	FLOAT(AOEFF)/100 															MEFF, 
	W.GQTY/W.SQTY 															AEFF,
	COALESCE(M.QTY,0)*W.GQTY/(FLOAT(AOEFF)/100) 											STDQ, 
	COALESCE(M.QTY,0)*W.GQTY/(FLOAT(AOEFF)/100)*COALESCE(CGSTCS, CHSTCS, Y0STCS) 						STDC,
	COALESCE(M.QTY,0)*W.GQTY/(FLOAT(AOEFF)/100)*
	COALESCE(CGSTCS, CASE CHLUC+CHSFC WHEN 0 THEN CHSTCS ELSE CHLUC+CHSFC END,Y0STCS) 						STDL,
	COALESCE(J.QTY,0)*W.GQTY/(FLOAT(COALESCE(CR.EDEFF, HR.EDEFF))/100) 								JOBQ, 
	COALESCE(J.QTY,0)*W.GQTY/(FLOAT(COALESCE(CR.EDEFF, HR.EDEFF))/100)*COALESCE(CGSTCS, CHSTCS, Y0STCS) 			JOBC,
	COALESCE(J.QTY,0)*W.GQTY/(FLOAT(COALESCE(CR.EDEFF, HR.EDEFF))/100)*
	COALESCE(CGSTCS, CASE CHLUC+CHSFC WHEN 0 THEN CHSTCS ELSE CHLUC+CHSFC END,Y0STCS)						JOBL,
	COALESCE(R.QTY,0)*(W.GQTY+W.SQTY) 													ACTQ,
	COALESCE(R.QTY,0)*(W.GQTY+W.SQTY)*COALESCE(CGSTCS, CHSTCS, Y0STCS)								ACTC,
	COALESCE(R.QTY,0)*(W.GQTY+W.SQTY)*
	COALESCE(CGSTCS, CASE CHLUC+CHSFC WHEN 0 THEN CHSTCS ELSE CHLUC+CHSFC END,Y0STCS)						ACTL,
	COALESCE(J.QTY,0)*W.GQTY/(FLOAT(COALESCE(CR.EDEFF, HR.EDEFF))/100) - COALESCE(M.QTY,0)*W.GQTY/(FLOAT(AOEFF)/100) 	MUVQ,
	COALESCE(J.QTY,0)*W.GQTY/(FLOAT(COALESCE(CR.EDEFF, HR.EDEFF))/100)*COALESCE(CGSTCS, CHSTCS, Y0STCS) - 
	COALESCE(M.QTY,0)*W.GQTY/(FLOAT(AOEFF)/100)*COALESCE(CGSTCS, CHSTCS, Y0STCS)						MUVD,
	COALESCE(J.QTY,0)*(W.GQTY)/(FLOAT(COALESCE(CR.EDEFF, HR.EDEFF))/100)*COALESCE(CGSTCS, CHLUC+CHSFC,Y0STCS) - 
	COALESCE(M.QTY,0)*(W.GQTY)/(FLOAT(AOEFF)/100)*COALESCE(CGSTCS, CHLUC+CHSFC,Y0STCS)  					MUVD_LUC,
	COALESCE(R.QTY,0)*(W.GQTY+W.SQTY)-COALESCE(M.QTY,0)*W.GQTY/(FLOAT(AOEFF)/100) 						JUVQ,
	(COALESCE(R.QTY,0)*(W.GQTY+W.SQTY)-COALESCE(M.QTY,0)*W.GQTY/(FLOAT(AOEFF)/100))*COALESCE(CGSTCS, CHSTCS, Y0STCS)	JUVD
FROM
	QTEMP.WPP W
	INNER JOIN QTEMP.UBOM U ON
		U.WRKO = W.WRKO AND
		U.PART = W.PART
	LEFT OUTER JOIN QTEMP.MBOM M ON
		M.WRKO = U.WRKO AND
		M.PART = U.PART AND
		M.SEQ = U.SEQ AND
		M.MTLP = U.MTLP AND
		M.UNIT = U.UNIT
	LEFT OUTER JOIN QTEMP.JBOM J ON
		J.WRKO = U.WRKO AND
		J.PART = U.PART AND
		J.SEQ = U.SEQ AND
		J.MTLP = U.MTLP AND
		J.UNIT = U.UNIT
	LEFT OUTER JOIN QTEMP.RBOM R ON
		R.WRKO = U.WRKO AND
		R.PART = U.PART AND
		R.SEQ = U.SEQ AND
		R.MTLP = U.MTLP AND
		R.UNIT = U.UNIT
	LEFT OUTER JOIN LGDAT.CJOBDR CR ON
		CR.EDJOB# = U.WRKO AND
		CR.EDSEQ# = U.SEQ
	LEFT OUTER JOIN LGDAT.HJOBDR HR ON
		HR.EDJOB# = U.WRKO AND
		HR.EDSEQ# = U.SEQ
	LEFT OUTER JOIN LGDAT.METHDR ON
		AOPART = W.PART AND
		AOPLNT = W.PLNT AND
		AOSEQ# = W.SEQ
	LEFT OUTER JOIN LGDAT.ICSTP ON
		CHPART = U.MTLP AND
		CHPLNT = W.PLNT
	LEFT OUTER JOIN LGDAT.ICSTM ON
		CGPART = U.MTLP AND
		CGPLNT = W.PLNT
	LEFT OUTER JOIN LGDAT.ICSTR ON
		Y0PART = U.MTLP AND
		Y0PLNT = W.PLNT
	LEFT OUTER JOIN LGDAT.STKMM ON
		AVPART = U.MTLP
	LEFT OUTER JOIN LGDAT.STKMP ON
		AWPART = U.MTLP	
	LEFT OUTER JOIN LGDAT.MMGP ON
		BRGRP = COALESCE(AVMAJG, AWMAJG) AND
		BRMGRP = COALESCE(AVMING, AWMING)
	LEFT OUTER JOIN LGDAT.MAJG ON
		BQGRP = COALESCE(AVMAJG, AWMAJG)
		
WHERE 
	U.WRKO = 'X001069351'
ORDER BY 
	U.WRKO ASC, MTLP ASC
*/

--DROP TABLE QTEMP.WPP
--DROP TABLE QTEMP.JBOM
--DROP TABLE QTEMP.MBOM
--DROP TABLE QTEMP.RBOM
--DROP TABLE QTEMP.UBOM
