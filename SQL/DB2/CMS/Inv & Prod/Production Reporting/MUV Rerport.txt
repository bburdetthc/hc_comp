--DECLARE GLOBAL TEMPORARY TABLE WPP (WRKO CHAR(10), PART CHAR(20), PLNT CHAR(3), STAT CHAR(1), SEQ INT, PERD CHAR(4), GQTY FLOAT, SQTY FLOAT)
--DECLARE GLOBAL TEMPORARY TABLE JBOM (WRKO CHAR(10), PART CHAR(20), SEQ INT, MTLP CHAR(20), UNIT CHAR(10), QTY FLOAT)
--DECLARE GLOBAL TEMPORARY TABLE MBOM (WRKO CHAR(10), PART CHAR(20), SEQ INT, MTLP CHAR(20), UNIT CHAR(10), QTY FLOAT)
--DECLARE GLOBAL TEMPORARY TABLE RBOM (WRKO CHAR(10), PART CHAR(20), SEQ INT, MTLP CHAR(20), UNIT CHAR(10), QTY FLOAT)
--DECLARE GLOBAL TEMPORARY TABLE UBOM (WRKO CHAR(10), PART CHAR(20), SEQ INT, MTLP CHAR(20), UNIT CHAR(10))



/*
INSERT INTO
	QTEMP.WPP
SELECT
	IXWRKO, IXPART, SUBSTR(IXDEPT,1,3) AS PLNT,			
	CASE IFNULL(H.DNPLNT,'X') WHEN 'X' THEN 'C' ELSE 'H' END STAT,
	IXSEQ#, DIGITS(IXFSYY)||DIGITS(IXFSPP) AS PERD,
	SUM(IXQTY), SUM(IXSCRP)
FROM
	LGDAT.PRTRAN
	LEFT OUTER JOIN LGDAT.CJOBH C ON					
		C.DNJOB = IXWRKO				
	LEFT OUTER JOIN LGDAT.HJOBH H ON					
		H.DNJOB = IXWRKO				
WHERE						
	IXFSYY = 14 AND					
	IXFSPP = 2 AND					
	IXPART <> ''
GROUP BY
	IXWRKO, IXPART, SUBSTR(IXDEPT,1,3), 					
	CASE IFNULL(H.DNPLNT,'X') WHEN 'X' THEN 'C' ELSE 'H' END,
	IXSEQ#, DIGITS(IXFSYY)||DIGITS(IXFSPP)
*/


/*
INSERT INTO
	QTEMP.JBOM
SELECT 
 	W.WRKO, W.PART, W.SEQ,
	COALESCE(C.EFMTLP, H.EFMTLP) MTLP,
	COALESCE(C.EFUNIT, H.EFUNIT)||' '||V6UNTI AS JOB_STKA,
 	SUM(
		CASE COALESCE(C.EFRQBY, H.EFRQBY) WHEN 'B' THEN -1 ELSE 1 END*
		COALESCE(C.EFQPPC, H.EFQPPC)/
		COALESCE(C.EFQTYM, H.EFQTYM)/
		(1-FLOAT(COALESCE(C.EFSCRP, H.EFSCRP))/100)*IFNULL(CNV1,1)/IFNULL(CNV2,1)
	) AS SCRPQTY
FROM 
	QTEMP.WPP W
 	LEFT OUTER JOIN LGDAT.CJOBDM C ON
		C.EFJOB# = W.WRKO AND
		C.EFSEQ# = W.SEQ
	LEFT OUTER JOIN LGDAT.HJOBDM H ON
		H.EFJOB# = W.WRKO AND
		H.EFSEQ# = W.SEQ
   	LEFT OUTER JOIN LGDAT.STKA A ON
  		V6PART = COALESCE(C.EFMTLP, H.EFMTLP) AND
  		V6PLNT = W.PLNT
 	LEFT OUTER JOIN 
 	(
  		SELECT 
			IHPART AS PART, IHUNT1 AS UNT1, IHUNT2 AS UNT2, IHCNV1 AS CNV1, IHCNV2 AS CNV2
  		FROM 
			LGDAT.PUNIT PUNIT
  		WHERE 
			PUNIT.IHPART='&&GLOBAL'
  		UNION ALL
  		SELECT 
			IHPART AS PART, IHUNT2 AS UNT1, IHUNT1 AS UNT2, IHCNV2 AS CNV1, IHCNV1 AS CNV2
  		FROM 
			LGDAT.PUNIT PUNIT
  		WHERE 
			PUNIT.IHPART='&&GLOBAL'
 	) X ON
  		V6UNTI = X.UNT1 AND
  		COALESCE(C.EFUNIT, H.EFUNIT) = X.UNT2
WHERE
	COALESCE(C.EFJOB#,H.EFJOB#,'X') <> 'X'
GROUP BY
	W.WRKO, W.PART, W.SEQ, 
	COALESCE(C.EFMTLP, H.EFMTLP), 
	COALESCE(C.EFUNIT, H.EFUNIT)||' '||V6UNTI
*/


/*
INSERT INTO
	QTEMP.MBOM
SELECT 
 	W.WRKO, W.PART, W.SEQ, 
	AQMTLP, 
	AQUNIT||' '||V6UNTI AS JOB_STKA,
 	SUM(
		CASE AQRQBY WHEN 'B' THEN -1 ELSE 1 END*
		AQQPPC/AQQTYM/(1-FLOAT(AQSCRP)/100)*IFNULL(CNV1,1)/IFNULL(CNV2,1)
	) AS SCRPQTY
FROM 
	QTEMP.WPP W
 	INNER JOIN LGDAT.METHDM ON
		AQPART = W.PART AND
		AQPLNT = W.PLNT AND
		AQSEQ# = W.SEQ
   	LEFT OUTER JOIN LGDAT.STKA A ON
  		V6PART = AQMTLP AND
  		V6PLNT = W.PLNT
 	LEFT OUTER JOIN 
 	(
  		SELECT 
			IHPART AS PART, IHUNT1 AS UNT1, IHUNT2 AS UNT2, IHCNV1 AS CNV1, IHCNV2 AS CNV2
  		FROM 
			LGDAT.PUNIT PUNIT
  		WHERE 
			PUNIT.IHPART='&&GLOBAL'
  		UNION ALL
  		SELECT 
			IHPART AS PART, IHUNT2 AS UNT1, IHUNT1 AS UNT2, IHCNV2 AS CNV1, IHCNV1 AS CNV2
  		FROM 
			LGDAT.PUNIT PUNIT
  		WHERE 
			PUNIT.IHPART='&&GLOBAL'
 	) X ON
  		V6UNTI = X.UNT1 AND
  		AQUNIT = X.UNT2
GROUP BY
	W.WRKO, W.PART, W.SEQ, 
	AQMTLP, 
	AQUNIT||' '||V6UNTI
*/


/*
INSERT INTO
	QTEMP.RBOM
SELECT 
 	W.WRKO, W.PART, W.SEQ, 
	UIMTLP, 
	UIUNMT||' '||V6UNTI AS JOB_STKA,
	SUM(UITQTY*IFNULL(CNV1,1)/IFNULL(CNV2,1))/SUM(UIRQTY) AS QTY
FROM 
	QTEMP.WPP W
	--somehow the prtran file will have to be linked to the rprm file in order to filter down the fiscal period
 	INNER JOIN LGDAT.RPRM ON
		UIJOB# = W.WRKO AND
		UIPART = W.PART AND
		SUBSTR(UIDEPT,1,3) = W.PLNT AND
		UISEQ# = W.SEQ
	INNER JOIN LGDAT.PRTRAN ON
		IXBTCH = UIBTID AND
		IXWRKO = UIJOB# AND
		IXPART = UIPART AND
		IXSEQ# = UISEQ# AND
		DIGITS(IXFSYY)||DIGITS(IXFSPP) = W.PERD AND
		IXQTY+IXSCRP <> 0 
   	LEFT OUTER JOIN LGDAT.STKA A ON
  		V6PART = UIMTLP AND
  		V6PLNT = W.PLNT
 	LEFT OUTER JOIN 
 	(
  		SELECT 
			IHPART AS PART, IHUNT1 AS UNT1, IHUNT2 AS UNT2, IHCNV1 AS CNV1, IHCNV2 AS CNV2
  		FROM 
			LGDAT.PUNIT PUNIT
  		WHERE 
			PUNIT.IHPART='&&GLOBAL'
  		UNION ALL
  		SELECT 
			IHPART AS PART, IHUNT2 AS UNT1, IHUNT1 AS UNT2, IHCNV2 AS CNV1, IHCNV1 AS CNV2
  		FROM 
			LGDAT.PUNIT PUNIT
  		WHERE 
			PUNIT.IHPART='&&GLOBAL'
 	) X ON
  		V6UNTI = X.UNT1 AND
  		UIUNMT = X.UNT2
GROUP BY
	W.WRKO, W.PART, W.SEQ, 
	UIMTLP, 
	UIUNMT||' '||V6UNTI
HAVING SUM(UIRQTY)<>0
*/


/*
INSERT INTO
	QTEMP.UBOM

SELECT
	WRKO , PART , SEQ , MTLP , UNIT
FROM
	QTEMP.JBOM

UNION

SELECT
	WRKO , PART , SEQ , MTLP , UNIT
FROM
	QTEMP.MBOM

UNION

SELECT
	WRKO , PART , SEQ , MTLP , UNIT
FROM
	QTEMP.RBOM
*/


SELECT
	W.PLNT, W.WRKO, W.PART,W.SEQ, W.GQTY, W.SQTY,
	U.MTLP, U.UNIT,
	COALESCE(M.QTY,0) MQTY, COALESCE(J.QTY,0) JQTY, COALESCE(R.QTY,0) RQTY,
	FLOAT(COALESCE(CR.EDEFF, HR.EDEFF))/100 EDEFF,
	COALESCE(CGSTCS, CHSTCS, Y0STCS) AS STCS,
	(COALESCE(J.QTY,0) - COALESCE(M.QTY,0))*COALESCE(CGSTCS, CHSTCS, Y0STCS)*(W.GQTY+W.SQTY)/(FLOAT(COALESCE(CR.EDEFF, HR.EDEFF))/100) AS MUV
FROM
	QTEMP.WPP W
	INNER JOIN QTEMP.UBOM U ON
		U.WRKO = W.WRKO AND
		U.PART = W.PART
	LEFT OUTER JOIN QTEMP.MBOM M ON
		M.WRKO = U.WRKO AND
		M.PART = U.PART AND
		M.SEQ = U.SEQ AND
		M.MTLP = U.MTLP AND
		M.UNIT = U.UNIT
	LEFT OUTER JOIN QTEMP.JBOM J ON
		J.WRKO = U.WRKO AND
		J.PART = U.PART AND
		J.SEQ = U.SEQ AND
		J.MTLP = U.MTLP AND
		J.UNIT = U.UNIT
	LEFT OUTER JOIN QTEMP.RBOM R ON
		R.WRKO = U.WRKO AND
		R.PART = U.PART AND
		R.SEQ = U.SEQ AND
		R.MTLP = U.MTLP AND
		R.UNIT = U.UNIT
	LEFT OUTER JOIN LGDAT.CJOBDR CR ON
		CR.EDJOB# = U.WRKO AND
		CR.EDSEQ# = U.SEQ
	LEFT OUTER JOIN LGDAT.HJOBDR HR ON
		HR.EDJOB# = U.WRKO AND
		HR.EDSEQ# = U.SEQ
	LEFT OUTER JOIN LGDAT.ICSTP ON
		CHPART = U.MTLP AND
		CHPLNT = W.PLNT
	LEFT OUTER JOIN LGDAT.ICSTM ON
		CGPART = U.MTLP AND
		CGPLNT = W.PLNT
	LEFT OUTER JOIN LGDAT.ICSTR ON
		Y0PART = U.MTLP AND
		Y0PLNT = W.PLNT
WHERE 
	U.WRKO = 'X001069351'
ORDER BY 
	U.WRKO ASC, MTLP ASC

--could allocate the reported total pieces among the lines in UBOM as a seperate field so that field could be aggregated for an accurate total pieces


--DROP TABLE QTEMP.WPP
--DROP TABLE QTEMP.JBOM
--DROP TABLE QTEMP.MBOM
--DROP TABLE QTEMP.RBOM
--DROP TABLE QTEMP.UBOM
