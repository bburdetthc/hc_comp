
SELECT
	DCODAT DCODAT,
	SUBSTR(CHAR(DCODAT),3,2)||SUBSTR(CHAR(DCODAT),6,2) ORD_PERD,
	DCMDAT,
	DCPO,
	DCPROM,
	DDORD#,
	DDITM#,
	DCSTAT,
	DDITST,
	CASE DDITST 
		WHEN 'C' THEN 
			CASE DDQTSI 
				WHEN 0 THEN 'CANCELED' 
				ELSE 'CLOSED'
			END
		ELSE 
			CASE WHEN DDQTSI >0 THEN 'BACKORDER' ELSE 'OPEN' END
	END CALC_STATUS,
	DDQTOI,
	DDQTSI,
	DDQTOI - DDQTSI QTY_I,
	DCCURR,
	DCBCUS,
	DCSCUS,
	SUBSTR(DDSTKL,1,3) PLNT,
	DDPART,
	DDGLC,
	DDCRRS,
	DCTRCD,
	DDTOTI,
	CASE DDQTOI WHEN 0 THEN 0 ELSE DDTOTI/DDQTOI END*(DDQTOI - DDQTSI)  OPEN_AMT,
	DCSHVI FESVIA,
	DIGITS(ZWSAL#) ACCT,
	AZGROP||' - '||RTRIM(BQ1TITL) FGRP,
	AVGLCD
FROM
	LGDAT.OCRI
	INNER JOIN LGDAT.OCRH ON
		DCORD# = DDORD#
	LEFT OUTER JOIN LGDAT.PLNT ON
		YAPLNT = SUBSTR(DDSTKL,1,3)
	LEFT OUTER JOIN LGDAT.CUST ON
		BVCUST = DCBCUS
	LEFT OUTER JOIN LGDAT.ARMASC ON
		ZWCOMP = BVCOMP AND
		ZWKEY1 = BVARCD AND
		ZWKEY2 = DDGLC AND
		ZWPLNT = CASE SUBSTR(BVCOMP,1,1) WHEN '3' THEN '0'||BVCOMP ELSE YAPLNT END	
	LEFT OUTER JOIN LGDAT.MAST ON
		AZCOMP||DIGITS(AZGL#1)||DIGITS(AZGL#2) = DIGITS(ZWSAL#)
	LEFT OUTER JOIN LGDAT.FGRP ON
		BQ1GRP = AZGROP
	LEFT OUTER JOIN FANALYSIS.VW_FFSTKMX ON
		AVPART = DDPART
		
WHERE
	DDITST <> 'C' AND
	DDQTOI - DDQTSI <> 0 AND 
	SUBSTR(AZGROP,1,3) IN ('410')