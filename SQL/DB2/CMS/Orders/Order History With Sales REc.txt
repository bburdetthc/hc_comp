SELECT
	ORD.*,
	BVCLAS,
	DIGITS(ZWSAL#) ACCT,
	AZGROP||' - '||RTRIM(BQ1TITL) FGRP,
	ORD_AMT*XO.RATE ORD_AMT_USD,
	ORD.DIEXT*XI.RATE INV_AMT_USD,
	CASE DDITST 
		WHEN 'C' THEN 
			CASE DDQTSI 
				WHEN 0 THEN 'CANCELED' 
				ELSE 'CLOSED'
			END
		ELSE 'OPEN'
	END ORD_STATUS
FROM
(
SELECT
	*
FROM
(
SELECT
	'REMAINDER' FLAG,
	DCODAT DCODAT,
	SUBSTR(CHAR(DCODAT),3,2)||SUBSTR(CHAR(DCODAT),6,2) ORD_PERD,
	DCPO,
	DDORD#,
	DDITM#,
	DCSTAT,
	DDITST,
	DDQTOI,
	DDQTSI,
	DDQTOI - DDQTSI QTY_I,
	DCCURR,
	DCBCUS,
	SUBSTR(DDSTKL,1,3) PLNT,
	DDGLC,
	DDCRRS,
	CASE DDQTOI WHEN 0 THEN 0 ELSE DDTOTI/DDQTOI END*(DDQTOI - DDQTSI)  ORD_AMT,
	0 BOL,
	0 BOLI,
	'' FESIND,
	0 INV#,
	0 INVI,
	'' INV_PERD,
	0 DIEXT
FROM
	LGDAT.OCRI
	INNER JOIN LGDAT.OCRH ON
		DCORD# = DDORD#
WHERE
	DCODAT >= '2014-10-01' AND
	DCODAT < '2015-10-01' AND
	DDQTOI - DDQTSI <> 0	

UNION ALL

SELECT
	'SHIPMENT' FLAG,
	DCODAT DCODAT,
	SUBSTR(CHAR(DCODAT),3,2)||SUBSTR(CHAR(DCODAT),6,2) ORD_PERD,
	CASE COALESCE(DHCPO,'') WHEN '' THEN DCPO ELSE DHCPO END DCPO,
	DDORD#,
	DDITM#,
	DCSTAT,
	DDITST,
	DDQTOI,
	DDQTSI,
	FGQSHP,
	DCCURR,
	DCBCUS,
	COALESCE(FGPLNT,SUBSTR(DDSTKL,1,3)) PLNT,
	DDGLC,
	COALESCE(DIREAS,DDCRRS) DDCRRS,
	CASE DDQTOI WHEN 0 THEN 0 ELSE DDTOTI/DDQTOI END*COALESCE(FGQSHP*CASE FESIND WHEN 'Y' THEN 1 ELSE 0 END,DDQTSI) ORD_AMT,
	FGBOL#,
	FGENT#,
	FESIND,
	DIINV#,
	DILIN#,
	DIGITS(DHARYR)||DIGITS(DHARPR) INV_PERD,
	DIEXT*CASE DHINCR WHEN 'C' THEN -1 ELSE 1 END DIEXT
	
FROM
	LGDAT.OCRI
	INNER JOIN LGDAT.OCRH ON
		DCORD# = DDORD#
	--------changed below join from inner to left, have ship quantities with no BOL, trying to resolve
	LEFT OUTER JOIN LGDAT.BOLD ON
		FGORD# = DDORD# AND
		FGITEM = DDITM#
	LEFT OUTER JOIN LGDAT.BOLH ON
		FEBOL# = FGBOL#
	LEFT OUTER JOIN LGDAT.OID ON
		DIINV# = FGINV# AND
		DILIN# = FGLIN#
	LEFT OUTER JOIN LGDAT.OIH ON
		DHINV# = DIINV#
WHERE
	DCODAT >= '2014-10-01' AND
	DCODAT < '2015-10-01' AND
	---------added this item to filter out
	DDQTSI <> 0	
) X

UNION ALL

SELECT
	CASE DHINCR WHEN 'C' THEN 'CREDIT' ELSE 'INVOICE' END,
	OH.DCODAT DCODAT,
	SUBSTR(CHAR(OH.DCODAT),3,2)||SUBSTR(CHAR(OH.DCODAT),6,2) ORD_PERD,
	COALESCE(DHCPO,OH.DCPO,CH.DCPO) DCPO,
	COALESCE(OD.DDORD#,CD.DDORD#) DDORD#,
	COALESCE(OD.DDITM#,CD.DDITM#) DDITM#,
	COALESCE(OH.DCSTAT, CH.DCSTAT) DCSTAT,
	COALESCE(OD.DDITST,CD.DDITST) DDITST,
	COALESCE(OD.DDQTOI,CD.DDQTOI) DDQTOI,
	COALESCE(OD.DDQTSI,CD.DDQTSI) DDQTSI,
	FGQSHP,
	COALESCE(OH.DCCURR,DHCURR) DCCURR,
	DHBCS# DCBCUS,
	DHPLNT PLNT,
	DIGLCD DDGLC,
	COALESCE(DIREAS, CD.DDCRRS) DDCRRS, 
	0 ORD_AMT,
	FGBOL#,
	FGENT#,
	FESIND,
	DIINV#,
	DILIN#,
	DIGITS(DHARYR)||DIGITS(DHARPR) INV_PERD,
	DIEXT*CASE DHINCR WHEN 'C' THEN -1 ELSE 1 END DIEXT
FROM
	LGDAT.OIH
	INNER JOIN LGDAT.OID ON
		DIINV# = DHINV#
	LEFT OUTER JOIN LGDAT.BOLD ON
		FGINV# = DIINV# AND
		FGLIN# = DILIN#
	LEFT OUTER JOIN LGDAT.BOLH ON
		FEBOL# = FGBOL#
	LEFT OUTER JOIN LGDAT.OCRI OD ON
		OD.DDORD# = FGORD# AND
		OD.DDITM# = FGITEM
	LEFT OUTER JOIN LGDAT.OCRH OH ON
		OH.DCORD# = OD.DDORD#
	LEFT OUTER JOIN LGDAT.CCRI CD ON
		CD.DDORD# = DIORD# AND
		CD.DDITM# = DILIN#
	LEFT OUTER JOIN LGDAT.CCRH CH ON
		CH.DCORD# = DIORD#
WHERE
	DIGITS(DHARYR)||DIGITS(DHARPR) >= '1410' AND
	DIGITS(DHARYR)||DIGITS(DHARPR) <= '1510' AND
	(COALESCE(CHAR(OH.DCODAT),'0001-01-01') < '2014-10-01' OR COALESCE(CHAR(OH.DCODAT),'0001-01-01') >= '2015-10-01')
) ORD
	LEFT OUTER JOIN FANALYSIS.FFCRET XO ON
		XO.FCUR = DCCURR AND
		XO.TCUR = 'US' AND
		XO.RTYP = 'MA' AND
		XO.PERD = ORD.ORD_PERD
	LEFT OUTER JOIN FANALYSIS.FFCRET XI ON
		XI.FCUR = DCCURR AND
		XI.TCUR = 'US' AND
		XI.RTYP = 'MA' AND
		XI.PERD = ORD.INV_PERD
	LEFT OUTER JOIN LGDAT.CUST BC ON
		BC.BVCUST = ORD.DCBCUS
	LEFT OUTER JOIN LGDAT.ARMASC ON
		ZWCOMP = BVCOMP AND
		ZWKEY1 = BVARCD AND
		ZWKEY2 = DDGLC AND
		ZWPLNT = CASE SUBSTR(BVCOMP,1,1) WHEN '3' THEN '0'||BVCOMP ELSE ORD.PLNT END
	LEFT OUTER JOIN LGDAT.MAST ON
		AZCOMP||DIGITS(AZGL#1)||DIGITS(AZGL#2) = DIGITS(ZWSAL#)
	LEFT OUTER JOIN LGDAT.FGRP ON
		BQ1GRP = AZGROP
FETCH FIRST 10 ROWS ONLY