WITH RL AS (
	SELECT 
		ACCT, CAST(CUSKEY1 AS INT) CUSKEY1, SUM(AMT) AMT
	FROM
		FANALYSISP.DBO.FFSBGLR1
	WHERE
		SUBSTRING(ACCT,7,4) = '1200' AND
		PERD >= '1701' AND 
		MODULE = 'ICRL'
	GROUP BY
		ACCT, CUSKEY1
),
	GR AS (
	SELECT
		RL.ACCT,
		RL.CUSKEY1,
		RL.AMT,
		JSRLG#, 
		JSVND#
	FROM
		RL
		INNER JOIN LGDAT.PORCH ON
			JSRLG# = CUSKEY1
	GROUP BY
		RL.ACCT,
		RL.CUSKEY1,
		RL.AMT,
		JSRLG#, 
		JSVND#
),
	AGG AS (
	SELECT
		ACCT, JSVND#, SUM(AMT) AMT
	FROM
		GR
	GROUP BY
		ACCT,
		JSVND#
	)

SELECT
	ACCT, 
	AMT,
	SUM(AMT) OVER (PARTITION BY ACCT) ACCT_AMT,
	JSVND#,
	ROUND((AMT/SUM(AMT) OVER (PARTITION BY ACCT)),5) PORTION
FROM
	AGG

OPTION (MAXDOP 8)